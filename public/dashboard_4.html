<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AMAC Voter Analytics</title>
    
    <!-- Dependencies -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css' rel='stylesheet' />
    <!-- TODO: For production, replace with proper Tailwind CSS installation -->
    <!-- See: https://tailwindcss.com/docs/installation -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --surface-0: #f9fafb;
            --surface-1: #ffffff;
            --surface-2: #f3f4f6;
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--surface-0);
            color: var(--text-primary);
        }

        .card {
            background: var(--surface-1);
            border: 1px solid var(--border);
            border-radius: 1rem;
            transition: all 0.2s;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        /* Dropdown Styles */
        .dropdown-container {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 50;
            max-height: 250px;
            overflow-y: auto;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--surface-1) 0%,
                var(--surface-2) 50%,
                var(--surface-1) 100%
            );
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Chat Interface */
        .chat-container {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            width: 320px;
            background: var(--surface-1);
            border: 1px solid var(--border);
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            z-index: 40;
            transition: all 0.3s ease;
            max-height: calc(100vh - 4rem);
        }

        .chat-container.collapsed {
            height: 60px;
            cursor: pointer;
        }

        .chat-container.expanded {
            height: 500px;
        }

        .chat-header {
            padding: 1rem;
            background: var(--surface-1);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .chat-messages {
            height: calc(100% - 120px);
            overflow-y: auto;
            padding: 1rem;
        }

        .chat-message {
            margin-bottom: 1rem;
            opacity: 0;
            transform: translateY(10px);
            animation: messageAppear 0.3s forwards;
        }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-ai {
            background: var(--surface-2);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-right: 2rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .message-user {
            background: var(--primary);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-left: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .chat-input {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
            background: var(--surface-1);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .chat-input input {
            flex: 1;
            background: var(--surface-2);
            border: 1px solid var(--border);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .chat-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary);
            background: var(--surface-1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-2);
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--surface-2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: var(--surface-0);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
            backdrop-filter: blur(4px);
        }

        #loading-overlay .text-center {
            width: 100%;
            max-width: 200px;
            margin: 0 auto;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--surface-2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.55, 0.25, 0.25, 0.7) infinite;
            box-shadow: var(--shadow-sm);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="text-center">
            <div class="spinner mb-4 mx-auto"></div>
            <p class="text-sm text-text-secondary text-center">Loading dashboard data...</p>
        </div>
    </div>

    <div class="min-h-screen p-3 sm:p-4 md:p-6 opacity-0 transition-opacity duration-300" id="dashboard-content">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 sm:gap-6 mb-6">
                <div class="flex items-center gap-4 sm:gap-6">
                    <img src="../assets/amac-logo.png" alt="AMAC Logo" class="h-12 sm:h-16 w-auto" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));" />
                    <div class="border-l border-gray-200 pl-4 sm:pl-6">
                        <h1 class="text-xl sm:text-2xl font-bold">Voter Analytics</h1>
                        <p class="text-xs text-gray-400">Last updated: April 2024</p>
                    </div>
                </div>

                <div class="flex items-center">
                    <button class="flex items-center gap-2 text-sm font-medium text-gray-600 hover:text-primary transition-colors">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Export
                    </button>
                </div>
            </div>
        </header>

        <!-- Filter Bar -->
        <div class="flex flex-col lg:flex-row gap-3 mb-4">
            <!-- Election Period -->
            <div class="w-full md:flex-1 bg-white rounded-lg shadow-sm p-2">
                <h3 class="text-xs font-medium mb-1.5">Election Period</h3>
                <div class="dropdown-container" x-data="{ 
                    open: false,
                    selectedElection: 'Nov 2024',
                    elections: ['Aug 2025', 'Nov 2024', 'Aug 2024', 'Feb 2024', 'Nov 2023', 'Aug 2023'],
                    updateElection(election) {
                        this.selectedElection = election;
                        // Update turnout data based on selected election
                        const turnoutData = {
                            'Aug 2025': 0,  // Future election
                            'Nov 2024': 76,
                            'Aug 2024': 68,
                            'Nov 2023': 72,
                            'Aug 2023': 65,
                            'Feb 2024': 58
                        };
                        
                        // Update the turnout stat
                        document.querySelectorAll('.stat-value')[1].textContent = turnoutData[election] + '%';
                        
                        // Update chart to highlight selected election
                        if (window.turnoutBarChart) {
                            const allElections = ['Aug 2025', 'Nov 2024', 'Aug 2024', 'Feb 2024', 'Nov 2023', 'Aug 2023'];
                            const data = allElections.map(e => turnoutData[e]);
                            window.turnoutBarChart.data.datasets[0].data = data;
                            window.turnoutBarChart.data.datasets[0].backgroundColor = data.map((d, i) => 
                                allElections[i] === election ? '#1d4ed8' : '#2563eb'
                            );
                            window.turnoutBarChart.update();
                        }
                    }
                }">
                    <button @click="open = !open" class="w-full h-[34px] flex items-center justify-between bg-white border border-gray-200 rounded px-2 hover:border-gray-300 transition-colors">
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="calendar" class="w-4 h-4 text-gray-500"></i>
                            <span class="text-sm text-gray-900 leading-none" x-text="selectedElection"></span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 flex-shrink-0"></i>
                    </button>
                    <div x-show="open" @click.away="open = false" class="dropdown-menu mt-1">
                        <div class="py-1">
                            <template x-for="election in elections" :key="election">
                                <button 
                                    @click="updateElection(election); open = false"
                                    class="w-full text-left px-3 py-1.5 hover:bg-gray-50 text-sm"
                                    :class="{'text-primary font-medium': selectedElection === election}"
                                    x-text="election">
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- State Selector -->
            <div class="w-full md:flex-1 bg-white rounded-lg shadow-sm p-2" x-data="stateSelector()" x-init="init()">
                <h3 class="text-xs font-medium mb-1.5">State</h3>
                <div class="dropdown-container">
                    <button @click="toggle()" class="w-full h-[34px] flex items-center justify-between bg-white border border-gray-200 rounded px-2 hover:border-gray-300 transition-colors">
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="map-pin" class="w-4 h-4 text-gray-500"></i>
                            <span class="text-sm text-gray-900 leading-none" x-text="selectedLabel"></span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 flex-shrink-0"></i>
                    </button>
                    <div x-show="open" @click.away="close" class="dropdown-menu mt-1">
                        <div class="py-1">
                            <template x-for="state in states" :key="state.key">
                                <button 
                                    @click="selectState(state.key)"
                                    class="w-full text-left px-3 py-1.5 text-sm hover:bg-gray-50"
                                    :class="{ 'text-primary font-medium': state.key === selectedKey }">
                                    <div class="flex items-center justify-between">
                                        <span x-text="state.label"></span>
                                        <span class="text-xs text-gray-400" x-text="state.abbr"></span>
                                    </div>
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Jurisdiction Type -->
            <div class="flex-1 bg-white rounded-lg shadow-sm p-2">
                <h3 class="text-xs font-medium mb-1.5">Jurisdiction</h3>
                <div class="dropdown-container" 
                    x-data="{ 
                        open: false, 
                        selected: 'Counties',
                        updateView() {
                            const data = {
                                'Counties': { count: 89450, areas: ['King County', 'Pierce County', 'Snohomish County'] },
                                'Legislative Districts': { count: 52340, areas: ['1st District', '2nd District', '3rd District'] },
                                'Congressional Districts': { count: 45230, areas: ['7th District', '8th District', '9th District'] },
                                'Cities': { count: 32180, areas: ['Seattle', 'Bellevue', 'Tacoma'] },
                                'School Districts': { count: 28900, areas: ['Seattle Public Schools', 'Bellevue School District', 'Spokane School District'] }
                            };

                            // Update voter count with selected jurisdiction's data
                            const totalVoters = data[this.selected]?.count || 0;
                            
                            // Update the stats
                            document.querySelectorAll('.stat-value')[0].textContent = totalVoters.toLocaleString();
                            
                            // Update the map via Alpine store
                            if (window.updateChoroplethView) {
                                window.updateChoroplethView(this.selected);
                            }
                        }
                    }"
                    @change="updateView">
                    <button @click="open = !open" class="w-full h-[34px] flex items-center justify-between bg-white border border-gray-200 rounded px-2 hover:border-gray-300 transition-colors">
                        <span class="text-sm text-gray-900 leading-none" x-text="selected || 'Select jurisdiction'">Select jurisdiction</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 flex-shrink-0 ml-1.5"></i>
                    </button>
                    <div x-show="open" @click.away="open = false" class="dropdown-menu mt-1">
                        <div class="py-1">
                            <label class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="jurisdiction" class="text-primary" value="Counties" x-model="selected">
                                <span class="text-sm text-gray-900">Counties</span>
                            </label>
                            <label class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="jurisdiction" class="text-primary" value="Legislative Districts" x-model="selected">
                                <span class="text-sm text-gray-900">Legislative Districts</span>
                            </label>
                            <label class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="jurisdiction" class="text-primary" value="Congressional Districts" x-model="selected">
                                <span class="text-sm text-gray-900">Congressional Districts</span>
                            </label>
                            <label class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="jurisdiction" class="text-primary" value="Cities" x-model="selected">
                                <span class="text-sm text-gray-900">Cities</span>
                            </label>
                            <label class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="jurisdiction" class="text-primary" value="School Districts" x-model="selected">
                                <span class="text-sm text-gray-900">School Districts</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Country of Origin Filter -->
            <div class="flex-1 bg-white rounded-lg shadow-sm p-2">
                <h3 class="text-xs font-medium mb-1.5">Country of Origin</h3>
                <div class="dropdown-container" 
                    x-data="{ 
                        open: false,
                        search: '',
                        selected: [],
                        countries: [
                            'Afghanistan', 'Albania', 'Algeria', 'American', 'Australia',
                            'Bangladesh', 'Belize', 'Bosnia and Herzegovina', 'Brunei', 'Cham',
                            'Costa Rica', 'Egypt', 'Eritrea', 'Estonia', 'Ethiopia',
                            'Guatemala', 'India', 'Indonesia', 'Iran', 'Iraq',
                            'Jordan', 'Kashmir', 'Lebanon', 'Mexico', 'Morocco',
                            'Myanmar', 'Pakistan', 'Palestine', 'Samoa', 'Saint Vincent and the Grenadines',
                            'Singapore', 'Somalia', 'South Africa', 'Sudan', 'Syria',
                            'Thailand', 'Tunisia', 'Turkey', 'Viet Nam', 'Yemen'
                        ],
                        get filteredCountries() {
                            return this.countries.filter(country => 
                                country.toLowerCase().includes(this.search.toLowerCase())
                            );
                        },
                        updateView() {
                            // Sample data distribution for visualization
                            const countryData = {};
                            this.selected.forEach((country, index) => {
                                countryData[country] = Math.floor(100 / (this.selected.length || 1));
                            });

                            // Update the donut chart
                            const ctx = document.getElementById('ethnicityChart').getContext('2d');
                            
                            // Create new data for selected countries
                            const chartData = {
                                labels: this.selected,
                                data: this.selected.map(c => countryData[c] || 0)
                            };

                            // Update or create chart
                            if (window.ethnicityChart) {
                                window.ethnicityChart.data.labels = chartData.labels;
                                window.ethnicityChart.data.datasets[0].data = chartData.data;
                                window.ethnicityChart.update();
                            }
                        }
                    }"
                    @change="updateView">
                    <button @click="open = !open" class="w-full h-[34px] flex items-center justify-between bg-white border border-gray-200 rounded px-2 hover:border-gray-300 transition-colors">
                        <span class="text-sm text-gray-900 leading-none" x-text="selected.length ? selected.join(', ') : 'Select countries'">Select countries</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 flex-shrink-0 ml-1.5"></i>
                    </button>
                    <div x-show="open" @click.away="open = false" class="dropdown-menu mt-1">
                        <div class="p-2 border-b border-gray-200">
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="country-search"
                                    name="country-search"
                                    x-model="search" 
                                    placeholder="Search countries..." 
                                    class="w-full px-2 py-1 text-sm border border-gray-200 rounded focus:outline-none focus:border-primary"
                                >
                                <i data-lucide="search" class="w-4 h-4 absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="py-1 max-h-48 overflow-y-auto">
                            <template x-for="country in filteredCountries" :key="country">
                                <label class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" class="text-primary rounded" :value="country" x-model="selected">
                                    <span class="text-sm text-gray-900" x-text="country"></span>
                                </label>
                            </template>
                            <div x-show="filteredCountries.length === 0" class="px-3 py-2 text-sm text-gray-500">
                                No countries found
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 gap-6">
            <!-- Main Content -->
            <div class="space-y-6">
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                    <div class="card card-hover p-4">
                        <p class="text-text-secondary text-sm mb-1">Total Registered Voters</p>
                        <h3 class="text-2xl font-bold stat-value" data-stat="registered-total">247,890</h3>
                        <div class="flex items-center gap-1 mt-2 text-success text-sm">
                            <i data-lucide="trending-up" class="w-4 h-4"></i>
                            <span>12.4%</span>
                        </div>
                    </div>
                    <div class="card card-hover p-4">
                        <p class="text-text-secondary text-sm mb-1">Current Turnout</p>
                        <h3 class="text-2xl font-bold stat-value" data-stat="turnout-average">76%</h3>
                        <div class="flex items-center gap-1 mt-2 text-success text-sm">
                            <i data-lucide="trending-up" class="w-4 h-4"></i>
                            <span>4.2%</span>
                        </div>
                    </div>
                    <div class="card card-hover p-4">
                        <p class="text-text-secondary text-sm mb-1">New Registrations</p>
                        <h3 class="text-2xl font-bold stat-value" data-stat="new-registrations">1,245</h3>
                        <div class="flex items-center gap-1 mt-2 text-warning text-sm">
                            <i data-lucide="trending-down" class="w-4 h-4"></i>
                            <span>2.1%</span>
                        </div>
                    </div>
                    <div class="card card-hover p-4">
                        <p class="text-text-secondary text-sm mb-1">Active Districts</p>
                        <h3 class="text-2xl font-bold stat-value" data-stat="active-areas">42</h3>
                        <div class="mt-2 text-text-secondary text-sm">
                            <span>of 49 total</span>
                        </div>
                    </div>
                </div>

                <!-- Map & Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <!-- Top Row: Map and Turnout -->
                    <div class="lg:col-span-8 card" style="height: 400px" x-data="choroplethMap()" x-init="init()">
                        <div class="absolute top-4 left-4 right-4 z-10 flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-gray-900" x-text="title"></h3>
                                <p class="text-xs text-gray-500" x-text="subtitle"></p>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="hidden sm:block bg-white/90 backdrop-blur rounded-lg shadow border border-gray-200 p-3" x-show="legend" x-transition>
                                    <div class="flex items-center justify-between text-[11px] font-semibold text-gray-600 mb-1">
                                        <span>Turnout %</span>
                                        <span x-text="legend.range"></span>
                                    </div>
                                    <div class="relative h-2 rounded-full overflow-hidden bg-gray-100">
                                        <div class="absolute inset-0 bg-gradient-to-r" :style="legend.gradient"></div>
                                    </div>
                                    <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                                        <span>Low</span>
                                        <span>High</span>
                                    </div>
                                </div>
                            <button 
                                    @click="openModal" 
                                class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-gray-600 hover:text-primary transition-colors bg-white/80 backdrop-blur rounded-md shadow-sm border border-gray-200">
                                <i data-lucide="maximize-2" class="w-4 h-4"></i>
                                Expand Map
                            </button>
                        </div>
                    </div>
                        <div class="absolute top-20 left-4 z-10 bg-white/90 backdrop-blur rounded-lg shadow border border-gray-200 p-3 w-56" x-show="legend" x-transition>
                            <template x-if="legend">
                                <div>
                                    <div class="flex items-center justify-between text-[11px] font-semibold text-gray-600 mb-1">
                                        <span>Turnout %</span>
                                        <span x-text="legend.range"></span>
                        </div>
                                    <div class="relative h-2 rounded-full overflow-hidden bg-gray-100">
                                        <div class="absolute inset-0 bg-gradient-to-r" :style="legend.gradient"></div>
                                    </div>
                                    <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                                        <span>Low</span>
                                        <span>High</span>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div id="map" class="w-full h-full rounded-lg"></div>

                        <!-- Modal overlay -->
                        <template x-if="modalOpen">
                            <div 
                                x-show="modalOpen"
                                x-transition.opacity
                                class="fixed inset-0 z-50 bg-black/60 backdrop-blur flex items-center justify-center p-4"
                                style="display:none">
                                <div class="bg-white w-full h-[90vh] rounded-2xl shadow-2xl border border-white/60 overflow-hidden relative">
                                    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                                        <div>
                                            <h3 class="text-lg font-semibold text-gray-900" x-text="title"></h3>
                                            <p class="text-xs text-gray-500" x-text="subtitle"></p>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 w-56" x-show="legend">
                                                <div class="flex items-center justify-between text-xs font-semibold text-gray-600 mb-1">
                                                    <span>Turnout %</span>
                                                    <span x-text="legend.range"></span>
                                                </div>
                                                <div class="relative h-2 rounded-full overflow-hidden bg-gray-100">
                                                    <div class="absolute inset-0 bg-gradient-to-r" :style="legend.gradient"></div>
                                                </div>
                                                <div class="flex justify-between text-[11px] text-gray-500 mt-1">
                                                    <span>Low</span>
                                                    <span>High</span>
                                                </div>
                                            </div>
                                    <button 
                                                @click="closeModal"
                                                class="p-2 text-gray-500 hover:text-gray-700 bg-white rounded-full border border-gray-200 shadow-sm">
                                                <i data-lucide="x" class="w-6 h-6"></i>
                                    </button>
                                </div>
                                </div>
                                    <div id="expanded-map" class="w-full h-full"></div>
                            </div>
                        </div>
                        </template>
                    </div>

                    <div class="lg:col-span-4 card p-4 space-y-4" x-data="turnoutGaugeWidget(53, 61821, 32795)" :class="expanded ? 'ring-2 ring-primary/50 shadow-lg shadow-primary/20' : ''">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-sm text-slate-500 uppercase tracking-wide">Voting Turnout</p>
                                <h3 class="text-lg font-semibold text-slate-900 mt-1">Current Participation Snapshot</h3>
                            </div>
                            <button class="p-2 rounded-lg bg-slate-100/80 text-slate-500 hover:text-primary hover:bg-primary/10 transition-colors" @click="toggleFullscreen" :aria-pressed="expanded">
                                <i :data-lucide="expanded ? 'minimize' : 'expand'" class="w-4 h-4"></i>
                            </button>
                        </div>

                        <div class="relative flex items-center justify-center">
                            <svg viewBox="0 0 200 120" class="w-full max-w-xs">
                                <defs>
                                    <linearGradient id="turnoutGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" stop-color="#2563eb" />
                                        <stop offset="100%" stop-color="#22d3ee" />
                                    </linearGradient>
                                </defs>
                                <path d="M20 100 A80 80 0 0 1 180 100" stroke="url(#turnoutGradient)" stroke-width="18" stroke-linecap="round" fill="transparent" opacity="0.12" />
                                <path :stroke-dasharray="gaugeStroke" :stroke-dashoffset="gaugeOffset" d="M20 100 A80 80 0 0 1 180 100" stroke="url(#turnoutGradient)" stroke-width="18" stroke-linecap="round" fill="transparent" class="transition-all duration-500 ease-out" />
                                <circle :cx="needlePosition.x" :cy="needlePosition.y" r="6" class="fill-white transition-all duration-500 ease-out" stroke="#2563eb" stroke-width="2" />
                            </svg>
                            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-[30%] text-center">
                                <p class="text-3xl font-bold text-slate-900" x-text="turnout + '%'">53%</p>
                                <p class="text-xs uppercase tracking-[0.35em] text-slate-500">Turnout</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 pt-2 border-t border-slate-100">
                            <div>
                                <p class="text-xs uppercase tracking-wide text-slate-500">Eligible Voters</p>
                                <p class="text-xl font-semibold text-slate-900" x-text="formatNumber(totalEligible)"></p>
                            </div>
                            <div>
                                <p class="text-xs uppercase tracking-wide text-slate-500">Ballots Cast</p>
                                <p class="text-xl font-semibold text-slate-900" x-text="formatNumber(totalVoted)"></p>
                            </div>
                        </div>

                        <div class="bg-slate-50/60 rounded-xl p-3">
                            <div class="flex items-center justify-between text-[11px] uppercase tracking-wider text-slate-500">
                                <span>Trend by Election</span>
                                <span class="text-slate-700 font-semibold" x-text="trendLabel"></span>
                            </div>
                            <div class="h-24 mt-2">
                                <canvas id="turnoutTrendSparkline"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Row: Jurisdiction and Ethnicity -->
                    <div class="lg:col-span-8 card p-4" style="min-height: 300px; max-height: 400px; overflow-y: auto;">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 sticky top-0 bg-surface-1 py-2">
                            <h3 class="font-medium mb-2 sm:mb-0">Top Jurisdictions</h3>
                            <select class="w-full sm:w-auto bg-surface-2 rounded px-2 py-1 text-sm">
                                <option>By Voter Count</option>
                                <option>By Turnout %</option>
                            </select>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <div class="flex flex-col sm:flex-row justify-between mb-2">
                                    <span class="font-medium mb-1 sm:mb-0">King County</span>
                            <span class="stat-value" data-stat="top-jurisdiction-0">89,450</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" style="width: 100%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex flex-col sm:flex-row justify-between mb-2">
                                    <span class="font-medium mb-1 sm:mb-0">7th Congressional District</span>
                            <span class="stat-value" data-stat="top-jurisdiction-1">45,230</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" style="width: 50%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex flex-col sm:flex-row justify-between mb-2">
                                    <span class="font-medium mb-1 sm:mb-0">Seattle</span>
                            <span class="stat-value" data-stat="top-jurisdiction-2">32,180</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" style="width: 35%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex flex-col sm:flex-row justify-between mb-2">
                                    <span class="font-medium mb-1 sm:mb-0">Bellevue</span>
                            <span class="stat-value" data-stat="top-jurisdiction-3">28,940</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" style="width: 32%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex flex-col sm:flex-row justify-between mb-2">
                                    <span class="font-medium mb-1 sm:mb-0">Tacoma</span>
                            <span class="stat-value" data-stat="top-jurisdiction-4">25,670</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" style="width: 29%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-4 card p-4" x-data="{
                        sortBy: 'turnout',
                        view: 'grid', // 'grid' or 'list'
                        countries: [
                            { name: 'Morocco', turnout: 100.0 },
                            { name: 'Kashmir', turnout: 88.9 },
                            { name: 'India', turnout: 82.3 },
                            { name: 'Egypt', turnout: 80.0 },
                            { name: 'American', turnout: 74.9 },
                            { name: 'Turkey', turnout: 69.0 },
                            { name: 'Bosnia and Herzegovina', turnout: 68.9 },
                            { name: 'Palestine', turnout: 68.7 },
                            { name: 'Pakistan', turnout: 68.2 },
                            { name: 'Bangladesh', turnout: 66.9 },
                            { name: 'Sudan', turnout: 59.8 },
                            { name: 'Syria', turnout: 58.3 },
                            { name: 'Iraq', turnout: 55.6 },
                            { name: 'Iran', turnout: 55.5 },
                            { name: 'Cham', turnout: 55.2 },
                            { name: 'Eritrea', turnout: 50.2 },
                            { name: 'Lebanon', turnout: 44.2 },
                            { name: 'Afghanistan', turnout: 41.4 },
                            { name: 'Ethiopia', turnout: 41.2 },
                            { name: 'Somalia', turnout: 29.1 }
                        ],
                        get sortedCountries() {
                            return [...this.countries].sort((a, b) => 
                                this.sortBy === 'name' 
                                    ? a.name.localeCompare(b.name)
                                    : b.turnout - a.turnout
                            );
                        },
                        getTurnoutColor(turnout) {
                            if (turnout >= 80) return 'bg-emerald-500';
                            if (turnout >= 60) return 'bg-blue-500';
                            if (turnout >= 40) return 'bg-amber-500';
                            return 'bg-rose-500';
                        }
                    }">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-medium">Voter Turnout by Country of Origin (option 1)</h3>
                            <div class="flex items-center gap-3">
                                <button 
                                    @click="view = 'grid'" 
                                    class="p-1.5 rounded-md transition-colors"
                                    :class="view === 'grid' ? 'bg-primary/10 text-primary' : 'text-gray-500 hover:text-primary'">
                                    <i data-lucide="grid" class="w-4 h-4"></i>
                                </button>
                                <button 
                                    @click="view = 'list'" 
                                    class="p-1.5 rounded-md transition-colors"
                                    :class="view === 'list' ? 'bg-primary/10 text-primary' : 'text-gray-500 hover:text-primary'">
                                    <i data-lucide="list" class="w-4 h-4"></i>
                                </button>
                                <div class="h-4 w-px bg-gray-200 mx-1"></div>
                                <button 
                                    @click="sortBy = 'name'" 
                                    class="p-1.5 rounded-md transition-colors"
                                    :class="sortBy === 'name' ? 'bg-primary/10 text-primary' : 'text-gray-500 hover:text-primary'">
                                    <i data-lucide="sort-asc" class="w-4 h-4"></i>
                                </button>
                                <button 
                                    @click="sortBy = 'turnout'" 
                                    class="p-1.5 rounded-md transition-colors"
                                    :class="sortBy === 'turnout' ? 'bg-primary/10 text-primary' : 'text-gray-500 hover:text-primary'">
                                    <i data-lucide="bar-chart-2" class="w-4 h-4"></i>
                                </button>
                        </div>
                    </div>

                        <!-- Grid View -->
                        <div x-show="view === 'grid'" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-[360px] overflow-y-auto pr-2">
                            <template x-for="country in sortedCountries" :key="country.name">
                                <div class="relative group">
                                    <div class="bg-gray-50 rounded-lg p-3 hover:bg-gray-100 transition-colors">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-sm font-medium truncate" x-text="country.name"></span>
                                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full" 
                                                  :class="getTurnoutColor(country.turnout)"
                                                  x-text="country.turnout + '%'"></span>
                </div>
                                        <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                            <div class="h-full transition-all duration-500 ease-out rounded-full"
                                                 :class="getTurnoutColor(country.turnout)"
                                                 :style="'width: ' + country.turnout + '%'"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- List View -->
                        <div x-show="view === 'list'" class="space-y-2 max-h-[360px] overflow-y-auto pr-2">
                            <template x-for="country in sortedCountries" :key="country.name">
                                <div class="flex items-center gap-4 p-2 hover:bg-gray-50 rounded-lg transition-colors">
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-sm font-medium" x-text="country.name"></span>
                                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full" 
                                                  :class="getTurnoutColor(country.turnout)"
                                                  x-text="country.turnout + '%'"></span>
                                        </div>
                                        <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                            <div class="h-full transition-all duration-500 ease-out rounded-full"
                                                 :class="getTurnoutColor(country.turnout)"
                                                 :style="'width: ' + country.turnout + '%'"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- New Bar Graph Widget -->
                    <div class="lg:col-span-6 card p-4" 
                         x-data="turnoutChart()"
                         x-init="initChart()">
                        <script>
                            document.addEventListener('alpine:init', () => {
                                Alpine.data('turnoutChart', () => ({
                                    countries: [
                                        { name: 'Morocco', turnout: 100.0, total: 18 },
                                        { name: 'Kashmir', turnout: 88.9, total: 20 },
                                        { name: 'India', turnout: 82.3, total: 214 },
                                        { name: 'Egypt', turnout: 80.0, total: 116 },
                                        { name: 'American', turnout: 74.9, total: 892 },
                                        { name: 'Turkey', turnout: 69.0, total: 3716 },
                                        { name: 'Bosnia and Herzegovina', turnout: 68.9, total: 5678 },
                                        { name: 'Palestine', turnout: 68.7, total: 1432 },
                                        { name: 'Pakistan', turnout: 68.2, total: 2891 },
                                        { name: 'Bangladesh', turnout: 66.9, total: 1567 },
                                        { name: 'Sudan', turnout: 59.8, total: 789 },
                                        { name: 'Syria', turnout: 58.3, total: 654 },
                                        { name: 'Iraq', turnout: 55.6, total: 987 },
                                        { name: 'Iran', turnout: 55.5, total: 1234 },
                                        { name: 'Cham', turnout: 55.2, total: 432 },
                                        { name: 'Eritrea', turnout: 50.2, total: 321 },
                                        { name: 'Lebanon', turnout: 44.2, total: 876 },
                                        { name: 'Afghanistan', turnout: 41.4, total: 543 },
                                        { name: 'Ethiopia', turnout: 41.2, total: 765 },
                                        { name: 'Somalia', turnout: 29.1, total: 234 }
                                    ],
                                    hoveredCountry: null,
                                    showAll: false,

                                    initChart() {
                                        this.countries = this.countries.sort((a, b) => b.turnout - a.turnout);
                                    },

                                    getBarColor(turnout) {
                                        if (turnout >= 80) return 'rgb(16, 185, 129)';  // emerald-500
                                        if (turnout >= 60) return 'rgb(59, 130, 246)';  // blue-500
                                        if (turnout >= 40) return 'rgb(245, 158, 11)';  // amber-500
                                        return 'rgb(239, 68, 68)';  // red-500
                                    },

                                    formatNumber(num) {
                                        return new Intl.NumberFormat().format(num);
                                    },

                                    get displayedCountries() {
                                        return this.showAll ? this.countries : this.countries.slice(0, 10);
                                    }
                                }));
                            });
                        </script>
                    }">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-medium">Voter Turnout Distribution (option 2)</h3>
                            <div class="flex items-center gap-2 text-xs text-gray-500">
                                <span class="flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                                    High Turnout
                                </span>
                                <span class="flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full bg-rose-400"></span>
                                    Low Turnout
                                </span>
                            </div>
                        </div>

                        <div class="space-y-3 max-h-[460px] overflow-y-auto pr-1">
                            <template x-for="(country, index) in displayedCountries" :key="country.name">
                                <div class="relative overflow-hidden rounded-xl border border-slate-200/60 bg-white/80 backdrop-blur-sm p-4 group hover:border-blue-500/40 hover:shadow-[0_15px_35px_-20px_rgba(37,99,235,0.55)] transition-all duration-200">
                                    <div class="absolute inset-0 opacity-0 group-hover:opacity-100 bg-gradient-to-r from-blue-500/10 via-transparent to-transparent transition-opacity duration-200"></div>
                                    <div class="relative flex items-center justify-between gap-4">
                                        <div class="flex items-center gap-3">
                                            <div class="h-10 w-10 rounded-xl bg-blue-100 text-blue-600 font-semibold grid place-items-center text-sm">
                                                <span x-text="String(index + 1).padStart(2, '0')"></span>
                                            </div>
                                            <div>
                                                <p class="text-sm font-semibold text-slate-800" x-text="country.name"></p>
                                                <p class="text-xs text-slate-500" x-text="formatNumber(country.total) + ' voters'"></p>
                                            </div>
                                        </div>
                                        <span class="text-sm font-semibold text-slate-600" x-text="country.turnout + '%'">
                                        </span>
                                    </div>
                                    <div class="relative mt-3 h-2 rounded-full bg-slate-200/70 overflow-hidden">
                                        <div class="absolute inset-y-0 left-0 rounded-full bg-gradient-to-r from-blue-600 via-blue-500 to-sky-400 shadow-[0_0_18px_rgba(37,99,235,0.35)] transition-all duration-300"
                                             :style="{ width: Math.min(country.turnout, 100) + '%' }"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <div class="flex justify-end mt-4">
                            <button 
                                @click="showAll = !showAll" 
                                class="text-xs font-medium text-blue-600 hover:text-blue-500 transition-colors">
                                <span x-text="showAll ? 'Show less' : 'View all countries'"></span>
                            </button>
                        </div>
                    </div>

                    <!-- Futuristic Bar Graph Widget -->
                    <div class="lg:col-span-6 card p-4 self-start" style="min-height: 0;">
                         <div class="flex items-center justify-between mb-4">
                             <div>
                                 <h3 class="font-medium">Turnout Distribution by Country of Origin (option 3)</h3>
                                 <p class="text-xs text-slate-500 mt-1">Hover to see total voters for each country</p>
                             </div>
                             <div class="flex items-center gap-2 text-xs text-gray-500">
                                 <span class="flex items-center gap-1">
                                     <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                                     Turnout %
                                 </span>
                             </div>
                         </div>
                         <div class="relative h-[220px]">
                             <canvas id="turnoutBarChart"></canvas>
                         </div>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="chat-container" 
         x-data="{ 
            expanded: false, 
            messages: [],
            sendMessage(text) {
                if (text.trim()) {
                    this.messages.push({type: 'user', text: text});
                    setTimeout(() => {
                        this.messages.push({
                            type: 'ai', 
                            text: 'Based on the voter data, ' + this.generateResponse(text)
                        });
                        this.$nextTick(() => {
                            document.getElementById('chat-messages').scrollTop = 
                            document.getElementById('chat-messages').scrollHeight;
                        });
                    }, 300);
                }
            },
            generateResponse(question) {
                // Simple response generation based on keywords
                if (question.toLowerCase().includes('turnout')) {
                    return 'the voter turnout shows an increasing trend with 76% in November 2024 compared to 72% in November 2023.';
                } else if (question.toLowerCase().includes('district') || question.toLowerCase().includes('highest')) {
                    return 'King County has the highest number of eligible voters with 89,450 registered voters.';
                } else if (question.toLowerCase().includes('compare')) {
                    return 'comparing the last two elections, we see a 4.2% increase in voter turnout.';
                }
                return 'I can help you analyze specific trends in voter turnout, district comparisons, or election period data.';
            }
         }"
         :class="expanded ? 'expanded' : 'collapsed'">
        
        <div class="chat-header" @click="expanded = !expanded">
            <div class="flex items-center gap-2">
                <i data-lucide="message-circle" class="w-5 h-5"></i>
                <span class="font-medium">Ask about the data</span>
            </div>
            <i data-lucide="chevron-up" class="w-5 h-5" x-show="expanded"></i>
            <i data-lucide="chevron-down" class="w-5 h-5" x-show="!expanded"></i>
        </div>
        
        <div x-show="expanded" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-4"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             class="chat-messages" 
             id="chat-messages">
            
            <div class="chat-message">
                <div class="message-ai">
                    Hi! I can help you analyze the voter data. Try asking questions like:
                    <ul class="mt-2 ml-4 list-disc text-sm">
                        <li>What's the voter turnout trend?</li>
                        <li>Which district has the highest turnout?</li>
                        <li>Compare turnout between elections</li>
                    </ul>
                </div>
            </div>

            <template x-for="message in messages">
                <div class="chat-message">
                    <div :class="message.type === 'user' ? 'message-user' : 'message-ai'"
                         x-text="message.text">
                    </div>
                </div>
            </template>
        </div>

        <div x-show="expanded" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-4"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             class="chat-input">
            <input type="text" 
                   id="chat-input"
                   name="chat-input"
                   placeholder="Ask a question about the data..."
                   @keyup.enter="sendMessage($event.target.value); $event.target.value = ''">
            <button class="p-2 hover:bg-surface-2 rounded-lg" 
                    @click="const input = $el.previousElementSibling; sendMessage(input.value); input.value = ''"
                    title="Send message">
                <i data-lucide="send" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <script>
        // Initialize Alpine.js
        const turnoutLegendGradient = 'background-image: linear-gradient(to right, #dc2626, #f97316, #facc15, #22c55e, #15803d)';

        const buildTooltip = (props, label = 'Turnout') => {
            const formattedTurnout = typeof props.turnout === 'number' ? props.turnout.toFixed(1) : props.turnout;
            const registered = typeof props.registered === 'number' ? props.registered.toLocaleString() : props.registered;
            const voted = typeof props.voted === 'number' ? props.voted.toLocaleString() : props.voted;
            const nonVoters = (typeof props.registered === 'number' && typeof props.voted === 'number')
                ? Math.max(props.registered - props.voted, 0).toLocaleString()
                : '';

            return `
                <div class="p-2">
                    <h4 class="font-semibold">${props.name || 'Unknown Region'}</h4>
                    <p class="text-sm">${label}: ${formattedTurnout}%</p>
                    <p class="text-sm">Registered: ${registered}</p>
                    <p class="text-sm">Voted: ${voted}</p>
                    <p class="text-sm">Non-Voters: ${nonVoters}</p>
                </div>
            `;
        };

        const rectangle = (lng1, lat1, lng2, lat2) => (
            [[
                [lng1, lat1],
                [lng1, lat2],
                [lng2, lat2],
                [lng2, lat1],
                [lng1, lat1]
            ]]
        );

        window.defaultStateKey = 'WA';
        window.stateConfigs = {
            WA: {
                label: 'Washington',
                abbr: 'WA',
                center: [-120.740135, 47.751076],
                zoom: 6,
                bounds: [[-125.0, 45.3], [-116.5, 49.2]],
                stats: {
                    registeredTotal: 247890,
                    turnoutAverage: 76,
                    newRegistrations: 1245,
                    activeAreas: 42,
                    topJurisdictions: [
                        { label: 'King County', value: 89450 },
                        { label: '7th Congressional District', value: 45230 },
                        { label: 'Seattle', value: 32180 },
                        { label: 'Bellevue', value: 28940 },
                        { label: 'Tacoma', value: 25670 }
                    ]
                }
            },
            CA: {
                label: 'California',
                abbr: 'CA',
                center: [-119.417931, 36.778259],
                zoom: 5,
                bounds: [[-125.0, 32.0], [-113.0, 42.2]],
                stats: {
                    registeredTotal: 1189050,
                    turnoutAverage: 68,
                    newRegistrations: 18230,
                    activeAreas: 120,
                    topJurisdictions: [
                        { label: 'Los Angeles County', value: 452310 },
                        { label: 'San Diego County', value: 187540 },
                        { label: 'Orange County', value: 165320 },
                        { label: 'San Francisco', value: 98650 },
                        { label: 'Sacramento County', value: 90560 }
                    ]
                }
            },
            FL: {
                label: 'Florida',
                abbr: 'FL',
                center: [-81.515753, 27.664827],
                zoom: 5.5,
                bounds: [[-88.5, 24.5], [-79.0, 31.1]],
                stats: {
                    registeredTotal: 904320,
                    turnoutAverage: 64,
                    newRegistrations: 15210,
                    activeAreas: 79,
                    topJurisdictions: [
                        { label: 'Miami-Dade County', value: 402130 },
                        { label: 'Broward County', value: 271540 },
                        { label: 'Orange County', value: 183200 },
                        { label: 'Palm Beach County', value: 176450 },
                        { label: 'Hillsborough County', value: 169820 }
                    ]
                }
            },
            OH: {
                label: 'Ohio',
                abbr: 'OH',
                center: [-82.907123, 40.417287],
                zoom: 6,
                bounds: [[-85.0, 38.0], [-80.0, 42.5]],
                stats: {
                    registeredTotal: 586320,
                    turnoutAverage: 71,
                    newRegistrations: 8230,
                    activeAreas: 48,
                    topJurisdictions: [
                        { label: 'Franklin County', value: 184560 },
                        { label: 'Cuyahoga County', value: 163420 },
                        { label: 'Hamilton County', value: 122340 },
                        { label: 'Summit County', value: 90560 },
                        { label: 'Montgomery County', value: 75800 }
                    ]
                }
            },
            DC: {
                label: 'Washington, D.C.',
                abbr: 'DC',
                center: [-77.036871, 38.907192],
                zoom: 10,
                bounds: [[-77.2, 38.8], [-76.9, 39.1]],
                stats: {
                    registeredTotal: 50340,
                    turnoutAverage: 82,
                    newRegistrations: 1240,
                    activeAreas: 8,
                    topJurisdictions: [
                        { label: 'Ward 3', value: 12840 },
                        { label: 'Ward 2', value: 11230 },
                        { label: 'Ward 6', value: 10520 },
                        { label: 'Ward 1', value: 8400 },
                        { label: 'Ward 4', value: 7370 }
                    ]
                }
            }
        };

        window.stateDatasets = {
            WA: {
                Counties: {
                title: 'County Turnout Overview',
                    subtitle: 'Washington | November 2024',
                legend: {
                    range: '0-100%',
                    gradient: turnoutLegendGradient
                },
                tooltipKey: 'name',
                tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                paint: {
                    'fill-color': [
                        'interpolate', ['linear'], ['get', 'turnout'],
                        0, '#dc2626',
                        55, '#f97316',
                        65, '#facc15',
                        75, '#22c55e',
                        90, '#15803d'
                    ],
                    'fill-opacity': 0.78,
                    'fill-outline-color': 'rgba(255,255,255,0.85)'
                },
                data: {
                    type: 'FeatureCollection',
                    features: [
                        { type: 'Feature', properties: { name: 'King County', turnout: 76.0, registered: 89450, voted: 67982 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.6, 47.1, -121.6, 47.9) } },
                        { type: 'Feature', properties: { name: 'Pierce County', turnout: 72.0, registered: 45230, voted: 32566 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.9, 46.7, -121.9, 47.3) } },
                        { type: 'Feature', properties: { name: 'Snohomish County', turnout: 74.2, registered: 72340, voted: 53631 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.5, 47.8, -121.5, 48.4) } },
                        { type: 'Feature', properties: { name: 'Spokane County', turnout: 68.4, registered: 35780, voted: 24473 }, geometry: { type: 'Polygon', coordinates: rectangle(-118.2, 47.3, -117.0, 48.0) } },
                        { type: 'Feature', properties: { name: 'Clark County', turnout: 70.1, registered: 42560, voted: 29836 }, geometry: { type: 'Polygon', coordinates: rectangle(-123.1, 45.5, -122.1, 46.1) } },
                        { type: 'Feature', properties: { name: 'Thurston County', turnout: 69.3, registered: 28900, voted: 20010 }, geometry: { type: 'Polygon', coordinates: rectangle(-123.3, 46.6, -122.4, 47.1) } },
                        { type: 'Feature', properties: { name: 'Whatcom County', turnout: 71.4, registered: 25670, voted: 18326 }, geometry: { type: 'Polygon', coordinates: rectangle(-123.1, 48.5, -121.9, 49.1) } },
                        { type: 'Feature', properties: { name: 'Yakima County', turnout: 65.2, registered: 18450, voted: 12068 }, geometry: { type: 'Polygon', coordinates: rectangle(-121.3, 46.0, -120.1, 46.6) } },
                        { type: 'Feature', properties: { name: 'Kitsap County', turnout: 73.3, registered: 31240, voted: 22901 }, geometry: { type: 'Polygon', coordinates: rectangle(-123.2, 47.4, -122.4, 47.8) } },
                        { type: 'Feature', properties: { name: 'Benton County', turnout: 67.1, registered: 22890, voted: 15329 }, geometry: { type: 'Polygon', coordinates: rectangle(-119.9, 45.8, -118.9, 46.4) } }
                    ]
                },
                fitBounds: [[-123.3, 45.5], [-117.0, 49.1]]
                }
            }
        };
        window.currentStateKey = window.defaultStateKey;
        window.choroplethDatasets = window.stateDatasets[window.currentStateKey];
        window.currentDatasetKey = 'Counties';
        window.choroplethMapInstance = null;
        window.expandedMapInstance = null;

        document.addEventListener('alpine:init', () => {
            Alpine.store('mapModal', {
                open: false
            })

            Alpine.data('choroplethMap', () => ({
                map: null,
                expandedMap: null,
                modalOpen: false,
                title: 'County Turnout Overview',
                subtitle: 'November 2024 | Top 10 Counties',
                datasetKey: 'Counties',
                legend: null,
                init() {
                    if (!window.mapboxgl || !mapboxgl.accessToken) {
                        console.warn('Mapbox token missing or MapboxGL not loaded');
                        return;
                    }
                    this.initializeMap('map');
                    window.updateChoroplethView = (key) => this.switchDataset(key);
                    this.switchDataset(this.datasetKey);
                },
                initializeMap(containerId, isExpanded = false) {
                    const mapInstance = new mapboxgl.Map({
                        container: containerId,
                        style: 'mapbox://styles/mapbox/light-v11',
                        center: [-120.740135, 47.751076],
                        zoom: 6,
                        pitch: 0,
                        bearing: 0,
                        antialias: true
                    });

                    mapInstance.on('load', () => {
                        this.loadDataset(mapInstance, this.datasetKey);
                        mapInstance.addControl(new mapboxgl.NavigationControl(), 'top-right');
                    });

                    mapInstance.on('error', (e) => {
                        console.error('Map error:', e);
                    });

                    if (isExpanded) {
                        this.expandedMap = mapInstance;
                        window.expandedMapInstance = mapInstance;
                    } else {
                        this.map = mapInstance;
                        window.choroplethMapInstance = mapInstance;
                    }
                },
                loadDataset(mapInstance, key) {
                    const dataSources = window.choroplethDatasets || {};
                    const dataset = dataSources[key] || dataSources['Counties'];
                    if (!dataset) return;

                    window.currentDatasetKey = key;
                    this.title = dataset.title;
                    this.subtitle = dataset.subtitle;
                    this.legend = dataset.legend;

                    const sourceId = 'voter-data';
                    const layerId = 'voter-choropleth';
                    const hoverLayerId = 'voter-choropleth-hover';

                    if (mapInstance.getLayer(hoverLayerId)) mapInstance.removeLayer(hoverLayerId);
                    if (mapInstance.getLayer(layerId)) mapInstance.removeLayer(layerId);
                    if (mapInstance.getSource(sourceId)) mapInstance.removeSource(sourceId);

                    mapInstance.addSource(sourceId, {
                        type: 'geojson',
                        data: dataset.data
                    });

                    mapInstance.addLayer({
                        id: layerId,
                        type: 'fill',
                        source: sourceId,
                        paint: dataset.paint
                    });

                    mapInstance.addLayer({
                        id: hoverLayerId,
                        type: 'line',
                        source: sourceId,
                        paint: {
                            'line-color': '#ffffff',
                            'line-width': 1.5
                        },
                        filter: ['==', ['get', 'name'], '']
                    });

                    const popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });

                    mapInstance.on('mousemove', layerId, (e) => {
                        if (!e.features?.length) return;
                        const feature = e.features[0];
                        mapInstance.setFilter(hoverLayerId, ['==', ['get', dataset.tooltipKey], feature.properties[dataset.tooltipKey]]);
                        popup.setLngLat(e.lngLat)
                            .setHTML(dataset.tooltipTemplate(feature.properties))
                            .addTo(mapInstance);
                    });

                    mapInstance.on('mouseleave', layerId, () => {
                        mapInstance.setFilter(hoverLayerId, ['==', ['get', dataset.tooltipKey], '']);
                        popup.remove();
                    });

                    if (dataset.fitBounds) {
                        mapInstance.fitBounds(dataset.fitBounds, { padding: 30, maxZoom: dataset.maxZoom ?? 8 });
                    }
                },
                openModal() {
                    this.modalOpen = true;
                    this.$nextTick(() => {
                        if (!this.expandedMap) {
                            this.initializeMap('expanded-map', true);
                        } else {
                            this.loadDataset(this.expandedMap, this.datasetKey);
                        }
                    });
                },
                closeModal() {
                    this.modalOpen = false;
                },
                switchDataset(key) {
                    this.datasetKey = key;
                    if (this.map) {
                        this.loadDataset(this.map, key);
                    }
                    if (this.expandedMap) {
                        this.loadDataset(this.expandedMap, key);
                    }
                }
            }));
        })

        function turnoutGaugeWidget(initialTurnout, totalEligible, totalVoted) {
            const radius = 80;
            const circumference = Math.PI * radius;

            return {
                turnout: Number(initialTurnout) || 0,
                totalEligible,
                totalVoted,
                expanded: false,
                get gaugeStroke() {
                    return circumference;
                },
                get gaugeOffset() {
                    const ratio = Math.max(0, Math.min(this.turnout, 100)) / 100;
                    return circumference * (1 - ratio);
                },
                get needlePosition() {
                    const clamped = Math.max(0, Math.min(this.turnout, 100));
                    const angle = Math.PI - (Math.PI * (clamped / 100));
                    return {
                        x: 100 + radius * Math.cos(angle),
                        y: 100 - radius * Math.sin(angle)
                    };
                },
                toggleFullscreen() {
                    this.expanded = !this.expanded;
                },
                get trendLabel() {
                    return this.turnout + '%  steady';
                },
                formatNumber(value) {
                    return new Intl.NumberFormat().format(value);
                }
            };
        }

        // Wait for Chart.js to load
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize charts first
            initializeCharts();
        });

        function initializeCharts() {
            // Initialize turnout chart
            const turnoutCtx = document.getElementById('turnoutTrendSparkline');
            if (turnoutCtx) {
                new Chart(turnoutCtx, {
                    type: 'line',
                    data: {
                        labels: ['Nov 23', 'Feb 24', 'Aug 24', 'Nov 24', 'Aug 25'],
                        datasets: [{
                            data: [49, 52, 55, 51, 53],
                            borderColor: '#2563eb',
                            borderWidth: 2.5,
                            pointRadius: 0,
                            tension: 0.4,
                            fill: {
                                target: 'origin',
                                above: 'rgba(37, 99, 235, 0.12)'
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { display: false },
                            y: { display: false, suggestedMin: 45, suggestedMax: 60 }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        }
                    }
                });
            }

            // Initialize ethnicity chart
            const ethnicityCtx = document.getElementById('ethnicityChart');
            if (ethnicityCtx) {
                new Chart(ethnicityCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['South Asian', 'Middle Eastern', 'African', 'Southeast Asian'],
                        datasets: [{
                            data: [45, 30, 15, 10],
                            backgroundColor: [
                                '#4361EE',  // South Asian (blue)
                                '#3A0CA3',  // Middle Eastern (deep purple)
                                '#7209B7',  // African (medium purple)
                                '#B5179E'   // Southeast Asian (light purple)
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                align: 'center',
                                labels: {
                                    color: '#4b5563',
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    font: {
                                        family: "'Inter', sans-serif",
                                        size: 12
                                    },
                                    boxWidth: 8
                                }
                            },
                            tooltip: {
                                backgroundColor: '#1f2937',
                                titleFont: {
                                    family: "'Inter', sans-serif",
                                    size: 14,
                                    weight: '600'
                                },
                                bodyFont: {
                                    family: "'Inter', sans-serif",
                                    size: 13
                                },
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + '%';
                                    }
                                }
                            }
                        },
                        cutout: '70%'
                    }
                });
            }
        }

        // Simulate loading state
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('loading-overlay').style.opacity = '0';
                document.getElementById('dashboard-content').style.opacity = '1';
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                }, 300);
            }, 1000);
        });

        // Initialize Lucide icons
        lucide.createIcons();

        // Initialize Mapbox
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2FqYS1yIiwiYSI6ImNtZXRjaHhiajAwcjgya3B5cjJqaDljZGwifQ.o1uEOA7pV2RB_0A8jicwqg';
        
        try {
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/light-v11',
                center: [-120.740135, 47.751076],
                zoom: 6,
                pitch: 0,
                bearing: 0,
                antialias: true
            });

            // Sample GeoJSON data for Washington counties
            const sampleData = {
                'type': 'FeatureCollection',
                'features': [
                    {
                        'type': 'Feature',
                        'properties': {
                            'name': 'King County',
                            'voter_count': 89450,
                            'turnout': 76
                        },
                        'geometry': {
                            'type': 'Polygon',
                            'coordinates': [[[-122.5, 47.4], [-122.5, 47.8], [-121.8, 47.8], [-121.8, 47.4], [-122.5, 47.4]]]
                        }
                    },
                    {
                        'type': 'Feature',
                        'properties': {
                            'name': 'Pierce County',
                            'voter_count': 45230,
                            'turnout': 72
                        },
                        'geometry': {
                            'type': 'Polygon',
                            'coordinates': [[[-122.8, 47.0], [-122.8, 47.4], [-122.1, 47.4], [-122.1, 47.0], [-122.8, 47.0]]]
                        }
                    },
                    {
                        'type': 'Feature',
                        'properties': {
                            'name': 'Snohomish County',
                            'voter_count': 72340,
                            'turnout': 74
                        },
                        'geometry': {
                            'type': 'Polygon',
                            'coordinates': [[[-122.3, 47.8], [-122.3, 48.2], [-121.6, 48.2], [-121.6, 47.8], [-122.3, 47.8]]]
                        }
                    },
                    {
                        'type': 'Feature',
                        'properties': {
                            'name': 'Spokane County',
                            'voter_count': 35780,
                            'turnout': 68
                        },
                        'geometry': {
                            'type': 'Polygon',
                            'coordinates': [[[-117.8, 47.4], [-117.8, 47.8], [-117.2, 47.8], [-117.2, 47.4], [-117.8, 47.4]]]
                        }
                    },
                    {
                        'type': 'Feature',
                        'properties': {
                            'name': 'Clark County',
                            'voter_count': 42560,
                            'turnout': 70
                        },
                        'geometry': {
                            'type': 'Polygon',
                            'coordinates': [[[-122.7, 45.6], [-122.7, 45.9], [-122.2, 45.9], [-122.2, 45.6], [-122.7, 45.6]]]
                        }
                    },
                    {
                        'type': 'Feature',
                        'properties': {
                            'name': 'Thurston County',
                            'voter_count': 28900,
                            'turnout': 69
                        },
                        'geometry': {
                            'type': 'Polygon',
                            'coordinates': [[[-123.1, 46.7], [-123.1, 47.0], [-122.6, 47.0], [-122.6, 46.7], [-123.1, 46.7]]]
                        }
                    },
                    {
                        'type': 'Feature',
                        'properties': {
                            'name': 'Whatcom County',
                            'voter_count': 25670,
                            'turnout': 71
                        },
                        'geometry': {
                            'type': 'Polygon',
                            'coordinates': [[[-122.8, 48.7], [-122.8, 49.0], [-122.1, 49.0], [-122.1, 48.7], [-122.8, 48.7]]]
                        }
                    },
                    {
                        'type': 'Feature',
                        'properties': {
                            'name': 'Yakima County',
                            'voter_count': 18450,
                            'turnout': 65
                        },
                        'geometry': {
                            'type': 'Polygon',
                            'coordinates': [[[-120.9, 46.3], [-120.9, 46.7], [-120.2, 46.7], [-120.2, 46.3], [-120.9, 46.3]]]
                        }
                    },
                    {
                        'type': 'Feature',
                        'properties': {
                            'name': 'Kitsap County',
                            'voter_count': 31240,
                            'turnout': 73
                        },
                        'geometry': {
                            'type': 'Polygon',
                            'coordinates': [[[-123.0, 47.4], [-123.0, 47.8], [-122.5, 47.8], [-122.5, 47.4], [-123.0, 47.4]]]
                        }
                    },
                    {
                        'type': 'Feature',
                        'properties': {
                            'name': 'Benton County',
                            'voter_count': 22890,
                            'turnout': 67
                        },
                        'geometry': {
                            'type': 'Polygon',
                            'coordinates': [[[-119.6, 46.0], [-119.6, 46.3], [-119.0, 46.3], [-119.0, 46.0], [-119.6, 46.0]]]
                        }
                    }
                ]
            };

            // Handle map modal
            let expandedMap = null;

            // Watch for modal open/close
            document.addEventListener('alpine:initialized', () => {
                Alpine.data('mapModal', () => ({
                    open: false,
                    init() {
                        this.$watch('open', value => {
                            if (value && !expandedMap && map) {
                                // Create expanded map when modal opens
                        expandedMap = new mapboxgl.Map({
                            container: 'expanded-map',
                            style: 'mapbox://styles/mapbox/light-v11',
                            center: map.getCenter(),
                            zoom: map.getZoom(),
                            pitch: 0,
                            bearing: 0,
                            antialias: true
                        });

                                // Copy the data source and layer from the main map
                        expandedMap.on('load', () => {
                            expandedMap.addSource('voter-data', {
                                'type': 'geojson',
                                'data': sampleData
                            });

                            expandedMap.addLayer({
                                'id': 'voter-choropleth',
                                'type': 'fill',
                                'source': 'voter-data',
                                'paint': {
                                    'fill-color': [
                                        'interpolate',
                                        ['linear'],
                                        ['get', 'voter_count'],
                                                0, '#ef4444',
                                                20000, '#f59e0b',
                                                40000, '#fbbf24',
                                                60000, '#84cc16',
                                                80000, '#22c55e'
                                    ],
                                    'fill-opacity': 0.7,
                                    'fill-outline-color': '#ffffff'
                                }
                            });
                                });
                            } else if (!value && expandedMap) {
                                // Clean up map when modal closes
                                expandedMap.remove();
                                expandedMap = null;
                            }
                        });
                    }
                }));
            });

            map.on('load', () => {
                // Ensure terrain and 3D features are disabled
                map.setTerrain(null);
                
                // Add the data source
                map.addSource('voter-data', {
                    'type': 'geojson',
                    'data': sampleData
                });

                // Add choropleth layer
                map.addLayer({
                    'id': 'voter-choropleth',
                    'type': 'fill',
                    'source': 'voter-data',
                    'paint': {
                        'fill-color': [
                            'interpolate',
                            ['linear'],
                            ['get', 'voter_count'],
                            0, '#ef4444',      // Red for low numbers
                            20000, '#f59e0b',  // Orange-yellow for low-medium
                            40000, '#fbbf24',  // Yellow for medium
                            60000, '#84cc16',  // Light green for medium-high
                            80000, '#22c55e'   // Green for high numbers
                        ],
                        'fill-opacity': 0.7,
                        'fill-outline-color': '#ffffff'
                    }
                });

                // Add hover effect
                map.addLayer({
                    'id': 'voter-choropleth-hover',
                    'type': 'line',
                    'source': 'voter-data',
                    'paint': {
                        'line-color': '#ffffff',
                        'line-width': 2
                    },
                    'filter': ['==', ['get', 'name'], '']
                });

                // Add popup on hover
                const popup = new mapboxgl.Popup({
                    closeButton: false,
                    closeOnClick: false
                });

                map.on('mousemove', 'voter-choropleth', (e) => {
                    if (e.features.length > 0) {
                        const feature = e.features[0];
                        
                        // Update hover effect
                        map.setFilter('voter-choropleth-hover', ['==', ['get', 'name'], feature.properties.name]);
                        
                        // Show popup
                        popup.setLngLat(e.lngLat)
                            .setHTML(`
                                <div class="p-2">
                                    <h4 class="font-medium">${feature.properties.name}</h4>
                                    <p class="text-sm">Registered Voters: ${feature.properties.voter_count.toLocaleString()}</p>
                                    <p class="text-sm">Turnout: ${feature.properties.turnout}%</p>
                                </div>
                            `)
                            .addTo(map);
                    }
                });

                map.on('mouseleave', 'voter-choropleth', () => {
                    map.setFilter('voter-choropleth-hover', ['==', ['get', 'name'], '']);
                    popup.remove();
                });

                // No 3D buildings for flat map
            });

            map.on('error', (e) => {
                console.error('Map error:', e);
                document.getElementById('map').innerHTML = `
                    <div class="flex items-center justify-center h-full bg-surface-2 rounded-lg">
                        <div class="text-center p-4">
                            <i data-lucide="map-off" class="w-8 h-8 mx-auto mb-2 text-text-secondary"></i>
                            <p class="text-text-secondary">Map loading error. Please check your connection.</p>
                        </div>
                    </div>
                `;
            });
        } catch (error) {
            console.error('Map initialization error:', error);
            document.getElementById('map').innerHTML = `
                <div class="flex items-center justify-center h-full bg-surface-2 rounded-lg">
                    <div class="text-center p-4">
                        <i data-lucide="map-off" class="w-8 h-8 mx-auto mb-2 text-text-secondary"></i>
                        <p class="text-text-secondary">Unable to load map. Please check your API key.</p>
                    </div>
                </div>
            `;
        }

        // Add navigation controls if map is initialized
        if (map && typeof map.addControl === 'function') {
            map.addControl(new mapboxgl.NavigationControl());
        }

        // Initialize Charts
        // Date range picker modal
        const dateRangeModal = document.createElement('div');
        dateRangeModal.innerHTML = `
            <div id="dateRangePicker" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 w-96">
                    <h3 class="text-lg font-semibold mb-4">Select Date Range</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="endDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div class="flex justify-end gap-3">
                            <button onclick="closeDateRangePicker()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md">Cancel</button>
                            <button onclick="applyDateRange()" class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary-dark rounded-md">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(dateRangeModal);

        const electionChartCanvas = document.getElementById('turnoutByElectionChart');
        if (electionChartCanvas) {
            const turnoutBarCtx = electionChartCanvas.getContext('2d');
            window.turnoutBarChart = new Chart(turnoutBarCtx, {
            type: 'bar',
            data: {
                labels: ['Aug 23', 'Nov 23','Feb 24', 'Aug 24', 'Nov 24', 'Aug 25'],
                datasets: [{
                    data: [58, 65, 72, 68, 76, null],
                    backgroundColor: '#2563eb',
                    borderRadius: {
                        topLeft: 4,
                        topRight: 4
                    },
                    barThickness: 40,
                    hoverBackgroundColor: '#1d4ed8'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 20,
                        right: 20,
                        bottom: 20,
                        left: 20
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: '#f3f4f6',
                            drawBorder: false
                        },
                        border: {
                            display: false
                        },
                        ticks: {
                            color: '#4b5563',
                            font: {
                                family: "'Inter', sans-serif",
                                size: 12
                            },
                            padding: 8,
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        border: {
                            display: false
                        },
                        ticks: {
                            color: '#4b5563',
                            font: {
                                family: "'Inter', sans-serif",
                                size: 12
                            },
                            padding: 8
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        titleFont: {
                            family: "'Inter', sans-serif",
                            size: 14,
                            weight: '600'
                        },
                        bodyFont: {
                            family: "'Inter', sans-serif",
                            size: 13
                        },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + '% Turnout';
                            }
                        }
                    }
                }
            }
        });
        }

        const futuristicCtx = document.getElementById('turnoutBarChart');
        if (futuristicCtx) {
            const countryLabels = ['Morocco', 'Kashmir', 'India', 'Egypt', 'American', 'Turkey', 'Bosnia & Herzegovina', 'Palestine', 'Pakistan', 'Bangladesh', 'Sudan', 'Syria', 'Iraq', 'Iran', 'Cham', 'Eritrea', 'Lebanon', 'Afghanistan', 'Ethiopia', 'Somalia'];
            const turnoutValues = [100.0, 88.9, 82.3, 80.0, 74.9, 69.0, 68.9, 68.7, 68.2, 66.9, 59.8, 58.3, 55.6, 55.5, 55.2, 50.2, 44.2, 41.4, 41.2, 29.1];
            const totalValues = [18, 20, 214, 116, 892, 3716, 5678, 1432, 2891, 1567, 789, 654, 987, 1234, 432, 321, 876, 543, 765, 234];

            new Chart(futuristicCtx, {
                type: 'bar',
            data: {
                    labels: countryLabels,
                datasets: [{
                        label: 'Turnout %',
                        data: turnoutValues,
                        backgroundColor: ctx => {
                            const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 320);
                            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.95)');
                            gradient.addColorStop(1, 'rgba(14, 165, 233, 0.45)');
                            return gradient;
                        },
                        borderRadius: 12,
                        barPercentage: 0.6,
                        categoryPercentage: 0.6,
                        hoverBackgroundColor: '#2563eb'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                            color: '#4b5563',
                            font: {
                                family: "'Inter', sans-serif",
                                    size: 11
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 110,
                            grid: {
                                color: 'rgba(148, 163, 184, 0.2)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#4b5563',
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                },
                                callback: value => value + '%'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                    },
                    tooltip: {
                            backgroundColor: '#0f172a',
                        titleFont: {
                            family: "'Inter', sans-serif",
                                size: 13,
                            weight: '600'
                        },
                        bodyFont: {
                            family: "'Inter', sans-serif",
                                size: 12
                        },
                        padding: 12,
                            cornerRadius: 10,
                        callbacks: {
                                label: context => {
                                    const index = context.dataIndex;
                                    return [`Turnout: ${context.parsed.y}%`, `Total Voters: ${totalValues[index].toLocaleString()}`];
                            }
                        }
                    }
                    }
            }
        });
        }


        // Filter functions
        function filterLastElection() {
            // Update chart data for the most recent election (November 2024)
            turnoutChart.data.labels = ['Nov 24'];
            turnoutChart.data.datasets[0].data = [76];
            turnoutChart.update();
            
            // Update KPI cards
            document.querySelector('.stat-value').textContent = '76%';
            document.querySelector('.text-success').innerHTML = `
                <i data-lucide="trending-up" class="w-4 h-4"></i>
                <span>4.2%</span>
            `;

            // Update jurisdiction data
            const topJurisdictions = document.querySelector('.top-jurisdictions');
            if (topJurisdictions) {
                // Update with November 2024 data
                topJurisdictions.innerHTML = `
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="font-medium">King County</span>
                            <span class="stat-value">89,450</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: 100%"></div>
                        </div>
                    </div>
                `;
            }

            // Update active button state
            document.querySelectorAll('header button').forEach(btn => {
                btn.classList.remove('text-primary');
                if (btn.textContent.includes('Last Election')) {
                    btn.classList.add('text-primary');
                }
            });

            lucide.createIcons();
        }

        function showDateRangePicker() {
            document.getElementById('dateRangePicker').classList.remove('hidden');
        }

        function closeDateRangePicker() {
            document.getElementById('dateRangePicker').classList.add('hidden');
        }

        function applyDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            // Format dates for display
            const formattedStartDate = new Date(startDate).toLocaleDateString();
            const formattedEndDate = new Date(endDate).toLocaleDateString();
            
            // Update the displayed date range
            const dateRangeElement = document.querySelector('[x-data*="dateRange"]');
            if (dateRangeElement) {
                const alpineData = Alpine.raw(dateRangeElement.__x.$data);
                alpineData.dateRange = `${formattedStartDate} - ${formattedEndDate}`;
                alpineData.open = false;
            }

            // Update chart with filtered data
            const filteredData = filterDataByDateRange(startDate, endDate);
            turnoutChart.data.labels = filteredData.labels;
            turnoutChart.data.datasets[0].data = filteredData.data;
            turnoutChart.update();
        }

        function filterDataByDateRange(startDate, endDate) {
            // This is a placeholder function - in reality, you would fetch data from your backend
            const allData = {
                labels: ['Nov 24', 'Aug 24', 'Feb 24', 'Nov 23', 'Aug 23'],
                data: [76, 68, 58, 72, 65]
            };
            
            // Filter data based on date range
            // This is simplified - you should use proper date comparison
            return allData;
        }

        // Cache common filter combinations
        const cachedFilters = {
            'last-election': {
                period: 'November 2024',
                jurisdiction: 'County',
                ethnicity: 'All'
            }
        };

        // Handle filter changes
        document.querySelectorAll('input[type="checkbox"], button').forEach(element => {
            element.addEventListener('click', () => {
                // Simulate loading state for filter changes
                const overlay = document.createElement('div');
                overlay.className = 'absolute inset-0 bg-surface-0 bg-opacity-50 flex items-center justify-center';
                overlay.innerHTML = '<div class="spinner"></div>';
                
                setTimeout(() => {
                    overlay.remove();
                }, 500);
            });
        });
    </script>
</body>
</html>
