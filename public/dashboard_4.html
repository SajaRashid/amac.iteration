<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AMAC Voter Analytics</title>
    
    <!-- Dependencies -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css' rel='stylesheet' />
    <!-- TODO: For production, replace with proper Tailwind CSS installation -->
    <!-- See: https://tailwindcss.com/docs/installation -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --surface-0: #f9fafb;
            --surface-1: #ffffff;
            --surface-2: #f3f4f6;
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--surface-0);
            color: var(--text-primary);
        }

        .card {
            background: var(--surface-1);
            border: 1px solid var(--border);
            border-radius: 1rem;
            transition: all 0.2s;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        /* Dropdown Styles */
        .dropdown-container {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 50;
            max-height: 250px;
            overflow-y: auto;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--surface-1) 0%,
                var(--surface-2) 50%,
                var(--surface-1) 100%
            );
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Chat Interface */
        .chat-container {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            width: 320px;
            background: var(--surface-1);
            border: 1px solid var(--border);
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            z-index: 40;
            transition: all 0.3s ease;
            max-height: calc(100vh - 4rem);
        }

        .chat-container.collapsed {
            height: 60px;
            cursor: pointer;
        }

        .chat-container.expanded {
            height: 500px;
        }

        .chat-header {
            padding: 1rem;
            background: var(--surface-1);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .chat-messages {
            height: calc(100% - 120px);
            overflow-y: auto;
            padding: 1rem;
        }

        .chat-message {
            margin-bottom: 1rem;
            opacity: 0;
            transform: translateY(10px);
            animation: messageAppear 0.3s forwards;
        }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-ai {
            background: var(--surface-2);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-right: 2rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .message-user {
            background: var(--primary);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-left: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .chat-input {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
            background: var(--surface-1);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .chat-input input {
            flex: 1;
            background: var(--surface-2);
            border: 1px solid var(--border);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .chat-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary);
            background: var(--surface-1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-2);
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--surface-2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: var(--surface-0);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
            backdrop-filter: blur(4px);
        }

        #loading-overlay .text-center {
            width: 100%;
            max-width: 200px;
            margin: 0 auto;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--surface-2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.55, 0.25, 0.25, 0.7) infinite;
            box-shadow: var(--shadow-sm);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="text-center">
            <div class="spinner mb-4 mx-auto"></div>
            <p class="text-sm text-text-secondary text-center">Loading dashboard data...</p>
        </div>
    </div>

    <div class="min-h-screen p-3 sm:p-4 md:p-6 opacity-0 transition-opacity duration-300" id="dashboard-content">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 sm:gap-6 mb-6">
                <div class="flex items-center gap-4 sm:gap-6">
                    <img src="assets/amac-logo.png" alt="AMAC Logo" class="h-12 sm:h-16 w-auto" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));" />
                    <div class="border-l border-gray-200 pl-4 sm:pl-6">
                        <h1 class="text-xl sm:text-2xl font-bold">Voter Analytics</h1>
                    </div>
                </div>

                <div class="flex items-center">
                    <button class="flex items-center gap-2 text-sm font-medium text-gray-600 hover:text-primary transition-colors">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Export
                    </button>
                </div>
            </div>
        </header>

        <!-- Mobile-Only Voter Turnout Widget (above filters) -->
        <div class="lg:hidden mb-4">
            <div class="card p-4 space-y-4" x-data="turnoutGaugeWidget()" :class="expanded ? 'ring-2 ring-primary/50 shadow-lg shadow-primary/20' : ''">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm text-slate-500 uppercase tracking-wide">Voting Turnout</p>
                        <h3 class="text-lg font-semibold text-slate-900 mt-1">Current Participation Snapshot</h3>
                    </div>
                    <button class="p-2 rounded-lg bg-slate-100/80 text-slate-500 hover:text-primary hover:bg-primary/10 transition-colors" @click="toggleFullscreen" :aria-pressed="expanded">
                        <i :data-lucide="expanded ? 'minimize' : 'expand'" class="w-4 h-4"></i>
                    </button>
                </div>

                <div class="relative flex items-center justify-center">
                    <svg viewBox="0 0 200 120" class="w-full max-w-xs">
                        <defs>
                            <linearGradient id="turnoutGradientMobile" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#2563eb" />
                                <stop offset="100%" stop-color="#22d3ee" />
                            </linearGradient>
                        </defs>
                        <path d="M20 100 A80 80 0 0 1 180 100" stroke="url(#turnoutGradientMobile)" stroke-width="18" stroke-linecap="round" fill="transparent" opacity="0.12" />
                        <path :stroke-dasharray="gaugeStroke" :stroke-dashoffset="gaugeOffset" d="M20 100 A80 80 0 0 1 180 100" stroke="url(#turnoutGradientMobile)" stroke-width="18" stroke-linecap="round" fill="transparent" class="transition-all duration-500 ease-out" />
                        <circle :cx="needlePosition.x" :cy="needlePosition.y" r="6" class="fill-white transition-all duration-500 ease-out" stroke="#2563eb" stroke-width="2" />
                    </svg>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-[30%] text-center">
                        <p class="text-3xl font-bold text-slate-900" x-text="turnout + '%'">53%</p>
                        <p class="text-xs uppercase tracking-[0.35em] text-slate-500">Turnout</p>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-2 border-t border-slate-100">
                    <div class="text-center flex-1">
                        <p class="text-xs uppercase tracking-wide text-slate-500">Eligible Voters</p>
                        <p class="text-xl font-semibold text-slate-900" x-text="formatNumber(totalEligible)"></p>
                    </div>
                    <div class="h-10 w-px bg-slate-200 mx-4"></div>
                    <div class="text-center flex-1">
                        <p class="text-xs uppercase tracking-wide text-slate-500">Ballots Cast</p>
                        <p class="text-xl font-semibold text-slate-900" x-text="formatNumber(totalVoted)"></p>
                    </div>
                </div>

                <div class="bg-slate-50/60 rounded-xl p-3">
                    <div class="flex items-center justify-between text-[11px] uppercase tracking-wider text-slate-500">
                        <span>Trend by Election</span>
                        <span class="text-slate-700 font-semibold" x-text="trendLabel"></span>
                    </div>
                    <div class="h-24 mt-2">
                        <canvas id="turnoutTrendSparklineMobile"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="flex flex-col lg:flex-row gap-3 mb-4">
            <!-- Election Period -->
            <div class="w-full md:flex-1 bg-white rounded-lg shadow-sm p-2">
                <h3 class="text-xs font-medium mb-1.5">Election Period</h3>
                <div class="dropdown-container" x-data="{ 
                    open: false,
                    selectedElection: 'Nov 2024',
                    elections: ['Aug 2025', 'Nov 2024', 'Aug 2024', 'Feb 2024', 'Nov 2023', 'Aug 2023'],
                    init() {
                        if (window.dashboardFilters) {
                            this.selectedElection = window.dashboardFilters.election;
                        }
                        window.addEventListener('dashboard:update', (event) => {
                            if (event.detail?.filters?.election) {
                                this.selectedElection = event.detail.filters.election;
                            }
                        });
                    },
                    updateElection(election) {
                        this.selectedElection = election;
                        if (window.dashboardFilters) {
                            window.dashboardFilters.election = election;
                            window.applyDashboardFilters?.();
                        }
                    }
                }">
                    <button @click="open = !open" class="w-full h-[34px] flex items-center justify-between bg-white border border-gray-200 rounded px-2 hover:border-gray-300 transition-colors">
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="calendar" class="w-4 h-4 text-gray-500"></i>
                            <span class="text-sm text-gray-900 leading-none" x-text="selectedElection"></span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 flex-shrink-0"></i>
                    </button>
                    <div x-show="open" @click.away="open = false" class="dropdown-menu mt-1">
                        <div class="py-1">
                            <template x-for="election in elections" :key="election">
                                <button 
                                    @click="updateElection(election); open = false"
                                    class="w-full text-left px-3 py-1.5 hover:bg-gray-50 text-sm"
                                    :class="{'text-primary font-medium': selectedElection === election}"
                                    x-text="election">
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- State Selector -->
            <div class="w-full md:flex-1 bg-white rounded-lg shadow-sm p-2" x-data="stateSelector()" x-init="init()">
                <h3 class="text-xs font-medium mb-1.5">State</h3>
                <div class="dropdown-container">
                    <button @click="toggle()" class="w-full h-[34px] flex items-center justify-between bg-white border border-gray-200 rounded px-2 hover:border-gray-300 transition-colors">
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="map-pin" class="w-4 h-4 text-gray-500"></i>
                            <span class="text-sm text-gray-900 leading-none" x-text="selectedLabel"></span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 flex-shrink-0"></i>
                    </button>
                    <div x-show="open" @click.away="close()" class="dropdown-menu mt-1">
                        <div class="py-1">
                            <template x-for="state in states" :key="state.key">
                                <button 
                                    @click="selectState(state.key)"
                                    class="w-full text-left px-3 py-1.5 text-sm hover:bg-gray-50"
                                    :class="{ 'text-primary font-medium': state.key === selectedKey }">
                                    <div class="flex items-center justify-between">
                                        <span x-text="state.label"></span>
                                        <span class="text-xs text-gray-400" x-text="state.abbr"></span>
                                    </div>
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Jurisdiction Type -->
            <div class="flex-1 bg-white rounded-lg shadow-sm p-2">
                <h3 class="text-xs font-medium mb-1.5">Jurisdiction</h3>
                <div class="dropdown-container" 
                    x-data="{ 
                        open: false, 
                        selected: window.dashboardFilters?.jurisdiction || 'Counties',
                        options: ['Counties', 'Legislative Districts', 'Congressional Districts', 'Cities', 'School Districts'],
                        init() {
                            window.addEventListener('dashboard:update', (event) => {
                                if (event.detail?.filters?.jurisdiction) {
                                    this.selected = event.detail.filters.jurisdiction;
                                }
                            });
                        },
                        updateView(value) {
                            this.selected = value;
                            window.applyDashboardFilters?.({ jurisdiction: value });
                        }
                    }"
                    x-init="init()">
                    <button @click="open = !open" class="w-full h-[34px] flex items-center justify-between bg-white border border-gray-200 rounded px-2 hover:border-gray-300 transition-colors">
                        <span class="text-sm text-gray-900 leading-none" x-text="selected || 'Select jurisdiction'">Select jurisdiction</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 flex-shrink-0 ml-1.5"></i>
                    </button>
                    <div x-show="open" @click.away="open = false" class="dropdown-menu mt-1">
                        <div class="py-1">
                            <template x-for="option in options" :key="option">
                            <label class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="jurisdiction" class="text-primary" :value="option" :checked="selected === option" @change="updateView(option)">
                                    <span class="text-sm text-gray-900" x-text="option"></span>
                            </label>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Country of Origin Filter -->
            <div class="flex-1 bg-white rounded-lg shadow-sm p-2">
                <h3 class="text-xs font-medium mb-1.5">Country of Origin</h3>
                <div class="dropdown-container" 
                    x-data="{ 
                        open: false,
                        search: '',
                        selected: window.dashboardFilters?.countries ? [...window.dashboardFilters.countries] : [],
                        countries: window.dashboardData?.countryOptions || [],
                        init() {
                            if (window.dashboardFilters?.countries) {
                                this.selected = [...window.dashboardFilters.countries];
                            }
                            window.addEventListener('dashboard:update', (event) => {
                                if (Array.isArray(event.detail?.filters?.countries)) {
                                    this.selected = [...event.detail.filters.countries];
                                }
                            });
                        },
                        get filteredCountries() {
                            return this.countries.filter(country => 
                                country.toLowerCase().includes(this.search.toLowerCase())
                            );
                        },
                        toggleCountry(country) {
                            if (this.selected.includes(country)) {
                                this.selected = this.selected.filter(c => c !== country);
                            } else {
                                this.selected = [...this.selected, country];
                            }
                            window.applyDashboardFilters?.({ countries: [...this.selected] });
                        }
                    }"
                    x-init="init()">
                    <button @click="open = !open" class="w-full h-[34px] flex items-center justify-between bg-white border border-gray-200 rounded px-2 hover:border-gray-300 transition-colors">
                        <span class="text-sm text-gray-900 leading-none" x-text="selected.length ? selected.join(', ') : 'Select countries'">Select countries</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 flex-shrink-0 ml-1.5"></i>
                    </button>
                    <div x-show="open" @click.away="open = false" class="dropdown-menu mt-1">
                        <div class="p-2 border-b border-gray-200">
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="country-search"
                                    name="country-search"
                                    x-model="search" 
                                    placeholder="Search countries..." 
                                    class="w-full px-2 py-1 text-sm border border-gray-200 rounded focus:outline-none focus:border-primary"
                                >
                                <i data-lucide="search" class="w-4 h-4 absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="py-1 max-h-48 overflow-y-auto">
                            <template x-for="country in filteredCountries" :key="country">
                                <label class="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" class="text-primary rounded" :value="country" :checked="selected.includes(country)" @change="toggleCountry(country)">
                                    <span class="text-sm text-gray-900" x-text="country"></span>
                                </label>
                            </template>
                            <div x-show="filteredCountries.length === 0" class="px-3 py-2 text-sm text-gray-500">
                                No countries found
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 gap-6">
            <!-- Main Content -->
            <div class="space-y-6">
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                    <div class="card card-hover p-4">
                        <p class="text-text-secondary text-sm mb-1">Total Registered Voters</p>
                        <h3 class="text-2xl font-bold stat-value" data-stat="registered-total">247,890</h3>
                        <div class="flex items-center gap-1 mt-2 text-success text-sm">
                            <i data-lucide="trending-up" class="w-4 h-4"></i>
                            <span>12.4%</span>
                        </div>
                    </div>
                    <div class="card card-hover p-4">
                        <p class="text-text-secondary text-sm mb-1">Current Turnout</p>
                        <h3 class="text-2xl font-bold stat-value" data-stat="turnout-average">76%</h3>
                        <div class="flex items-center gap-1 mt-2 text-success text-sm">
                            <i data-lucide="trending-up" class="w-4 h-4"></i>
                            <span>4.2%</span>
                        </div>
                    </div>
                    <div class="card card-hover p-4">
                        <p class="text-text-secondary text-sm mb-1">New Registrations</p>
                        <h3 class="text-2xl font-bold stat-value" data-stat="new-registrations">1,245</h3>
                        <div class="flex items-center gap-1 mt-2 text-warning text-sm">
                            <i data-lucide="trending-down" class="w-4 h-4"></i>
                            <span>2.1%</span>
                        </div>
                    </div>
                    <div class="card card-hover p-4">
                        <p class="text-text-secondary text-sm mb-1">Active Districts</p>
                        <h3 class="text-2xl font-bold stat-value" data-stat="active-areas">42</h3>
                        <div class="mt-2 text-text-secondary text-sm">
                            <span>of 49 total</span>
                        </div>
                    </div>
                </div>

                <!-- Map & Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-start">
                    <!-- Top Row: Map and Turnout -->
                    <div class="lg:col-span-8 card" style="height: 520px" x-data="choroplethMap()" x-init="init()">
                        <div class="absolute top-4 left-4 right-4 z-10 flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-gray-900" x-text="title"></h3>
                                <p class="text-xs text-gray-500" x-text="subtitle"></p>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="hidden sm:block bg-white/90 backdrop-blur rounded-lg shadow border border-gray-200 p-3" x-show="legend" x-transition>
                                    <div class="flex items-center justify-between text-[11px] font-semibold text-gray-600 mb-1">
                                        <span>Turnout %</span>
                                        <span x-text="legend.range"></span>
                                    </div>
                                    <div class="relative h-2 rounded-full overflow-hidden bg-gray-100">
                                        <div class="absolute inset-0 bg-gradient-to-r" :style="legend.gradient"></div>
                                    </div>
                                    <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                                        <span>Low</span>
                                        <span>High</span>
                                    </div>
                                </div>
                            <button 
                                    @click="openModal" 
                                class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-gray-600 hover:text-primary transition-colors bg-white/80 backdrop-blur rounded-md shadow-sm border border-gray-200">
                                <i data-lucide="maximize-2" class="w-4 h-4"></i>
                                Expand Map
                            </button>
                        </div>
                    </div>
                        <div class="absolute top-20 left-4 z-10 bg-white/90 backdrop-blur rounded-lg shadow border border-gray-200 p-3 w-56" x-show="legend" x-transition>
                            <template x-if="legend">
                                <div>
                                    <div class="flex items-center justify-between text-[11px] font-semibold text-gray-600 mb-1">
                                        <span>Turnout %</span>
                                        <span x-text="legend.range"></span>
                        </div>
                                    <div class="relative h-2 rounded-full overflow-hidden bg-gray-100">
                                        <div class="absolute inset-0 bg-gradient-to-r" :style="legend.gradient"></div>
                                    </div>
                                    <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                                        <span>Low</span>
                                        <span>High</span>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div id="map" class="w-full h-full rounded-lg"></div>

                        <!-- Modal overlay -->
                        <template x-if="modalOpen">
                            <div 
                                x-show="modalOpen"
                                x-transition.opacity
                                class="fixed inset-0 z-50 bg-black/60 backdrop-blur flex items-center justify-center md:p-4"
                                style="display:none">
                                <div class="bg-white w-full md:h-[90vh] h-full md:rounded-2xl shadow-2xl border border-white/60 overflow-hidden relative">
                                    <!-- Header - hidden on mobile, visible on desktop -->
                                    <div class="hidden md:flex items-center justify-between px-6 py-4 border-b border-gray-100">
                                        <div>
                                            <h3 class="text-lg font-semibold text-gray-900" x-text="title"></h3>
                                            <p class="text-xs text-gray-500" x-text="subtitle"></p>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 w-56" x-show="legend">
                                                <div class="flex items-center justify-between text-xs font-semibold text-gray-600 mb-1">
                                                    <span>Turnout %</span>
                                                    <span x-text="legend.range"></span>
                                                </div>
                                                <div class="relative h-2 rounded-full overflow-hidden bg-gray-100">
                                                    <div class="absolute inset-0 bg-gradient-to-r" :style="legend.gradient"></div>
                                                </div>
                                                <div class="flex justify-between text-[11px] text-gray-500 mt-1">
                                                    <span>Low</span>
                                                    <span>High</span>
                                                </div>
                                            </div>
                                            <button 
                                                @click="closeModal"
                                                class="p-2.5 text-white bg-red-500 hover:bg-red-600 rounded-full shadow-md transition-all hover:scale-110">
                                                <i data-lucide="x" class="w-5 h-5"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Mobile close button - positioned as overlay -->
                                    <button 
                                        @click="closeModal"
                                        class="md:hidden absolute top-4 right-4 z-[60] p-2.5 text-white bg-red-500 hover:bg-red-600 rounded-full shadow-lg transition-all hover:scale-110">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                    </button>
                                    <div id="expanded-map" class="w-full h-full"></div>
                            </div>
                        </div>
                        </template>
                    </div>

                    <!-- Desktop-Only Voter Turnout Widget (hidden on mobile) -->
                    <div class="hidden lg:block lg:col-span-4 card p-4 space-y-4" x-data="turnoutGaugeWidget()" :class="expanded ? 'ring-2 ring-primary/50 shadow-lg shadow-primary/20' : ''">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-sm text-slate-500 uppercase tracking-wide">Voting Turnout</p>
                                <h3 class="text-lg font-semibold text-slate-900 mt-1">Current Participation Snapshot</h3>
                            </div>
                            <button class="p-2 rounded-lg bg-slate-100/80 text-slate-500 hover:text-primary hover:bg-primary/10 transition-colors" @click="toggleFullscreen" :aria-pressed="expanded">
                                <i :data-lucide="expanded ? 'minimize' : 'expand'" class="w-4 h-4"></i>
                            </button>
                        </div>

                        <div class="relative flex items-center justify-center">
                            <svg viewBox="0 0 200 120" class="w-full max-w-xs">
                                <defs>
                                    <linearGradient id="turnoutGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" stop-color="#2563eb" />
                                        <stop offset="100%" stop-color="#22d3ee" />
                                    </linearGradient>
                                </defs>
                                <path d="M20 100 A80 80 0 0 1 180 100" stroke="url(#turnoutGradient)" stroke-width="18" stroke-linecap="round" fill="transparent" opacity="0.12" />
                                <path :stroke-dasharray="gaugeStroke" :stroke-dashoffset="gaugeOffset" d="M20 100 A80 80 0 0 1 180 100" stroke="url(#turnoutGradient)" stroke-width="18" stroke-linecap="round" fill="transparent" class="transition-all duration-500 ease-out" />
                                <circle :cx="needlePosition.x" :cy="needlePosition.y" r="6" class="fill-white transition-all duration-500 ease-out" stroke="#2563eb" stroke-width="2" />
                            </svg>
                            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-[30%] text-center">
                                <p class="text-3xl font-bold text-slate-900" x-text="turnout + '%'">53%</p>
                                <p class="text-xs uppercase tracking-[0.35em] text-slate-500">Turnout</p>
                            </div>
                        </div>

                        <div class="flex items-center justify-between pt-2 border-t border-slate-100">
                            <div class="text-center flex-1">
                                <p class="text-xs uppercase tracking-wide text-slate-500">Eligible Voters</p>
                                <p class="text-xl font-semibold text-slate-900" x-text="formatNumber(totalEligible)"></p>
                            </div>
                            <div class="h-10 w-px bg-slate-200 mx-4"></div>
                            <div class="text-center flex-1">
                                <p class="text-xs uppercase tracking-wide text-slate-500">Ballots Cast</p>
                                <p class="text-xl font-semibold text-slate-900" x-text="formatNumber(totalVoted)"></p>
                            </div>
                        </div>

                        <div class="bg-slate-50/60 rounded-xl p-3">
                            <div class="flex items-center justify-between text-[11px] uppercase tracking-wider text-slate-500">
                                <span>Trend by Election</span>
                                <span class="text-slate-700 font-semibold" x-text="trendLabel"></span>
                            </div>
                            <div class="h-24 mt-2">
                                <canvas id="turnoutTrendSparkline"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Row: Jurisdiction and Ethnicity -->
                    <div class="lg:col-span-8 card p-4" style="min-height: 300px; max-height: 400px; overflow-y: auto;">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 sticky top-0 bg-surface-1 py-2">
                            <h3 class="font-medium mb-2 sm:mb-0">Top Jurisdictions</h3>
                            <select class="w-full sm:w-auto bg-surface-2 rounded px-2 py-1 text-sm">
                                <option>By Voter Count</option>
                                <option>By Turnout %</option>
                            </select>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <div class="flex flex-col sm:flex-row justify-between mb-2">
                                    <span class="font-medium mb-1 sm:mb-0" data-top-label="0">King County</span>
                                    <span class="stat-value" data-stat="top-jurisdiction-0">89,450</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" data-top-progress="0" style="width: 100%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex flex-col sm:flex-row justify-between mb-2">
                                    <span class="font-medium mb-1 sm:mb-0" data-top-label="1">7th Congressional District</span>
                                    <span class="stat-value" data-stat="top-jurisdiction-1">45,230</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" data-top-progress="1" style="width: 70%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex flex-col sm:flex-row justify-between mb-2">
                                    <span class="font-medium mb-1 sm:mb-0" data-top-label="2">Seattle</span>
                                    <span class="stat-value" data-stat="top-jurisdiction-2">32,180</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" data-top-progress="2" style="width: 55%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex flex-col sm:flex-row justify-between mb-2">
                                    <span class="font-medium mb-1 sm:mb-0" data-top-label="3">Bellevue</span>
                                    <span class="stat-value" data-stat="top-jurisdiction-3">28,940</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" data-top-progress="3" style="width: 48%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex flex-col sm:flex-row justify-between mb-2">
                                    <span class="font-medium mb-1 sm:mb-0" data-top-label="4">Tacoma</span>
                                    <span class="stat-value" data-stat="top-jurisdiction-4">25,670</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" data-top-progress="4" style="width: 42%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Turnout Distribution by Country of Origin -->
                    <div class="lg:col-span-4 card p-4" style="min-height: 300px; max-height: 400px;">
                         <div class="flex items-center justify-between mb-4">
                             <div>
                                 <h3 class="font-medium">Turnout Distribution by Country of Origin</h3>
                                 <p class="text-xs text-slate-500 mt-1">Hover to see total voters for each country</p>
                             </div>
                             <div class="flex items-center gap-2 text-xs text-gray-500">
                                 <span class="flex items-center gap-1">
                                     <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                                     Turnout %
                                 </span>
                             </div>
                         </div>
                         <div class="relative h-[320px]">
                             <canvas id="turnoutBarChart"></canvas>
                         </div>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="chat-container" 
         x-data="{ 
            expanded: false, 
            messages: [],
            sendMessage(text) {
                if (text.trim()) {
                    this.messages.push({type: 'user', text: text});
                    setTimeout(() => {
                        this.messages.push({
                            type: 'ai', 
                            text: 'Based on the voter data, ' + this.generateResponse(text)
                        });
                        this.$nextTick(() => {
                            document.getElementById('chat-messages').scrollTop = 
                            document.getElementById('chat-messages').scrollHeight;
                        });
                    }, 300);
                }
            },
            generateResponse(question) {
                // Simple response generation based on keywords
                if (question.toLowerCase().includes('turnout')) {
                    return 'the voter turnout shows an increasing trend with 76% in November 2024 compared to 72% in November 2023.';
                } else if (question.toLowerCase().includes('district') || question.toLowerCase().includes('highest')) {
                    return 'King County has the highest number of eligible voters with 89,450 registered voters.';
                } else if (question.toLowerCase().includes('compare')) {
                    return 'comparing the last two elections, we see a 4.2% increase in voter turnout.';
                }
                return 'I can help you analyze specific trends in voter turnout, district comparisons, or election period data.';
            }
         }"
         :class="expanded ? 'expanded' : 'collapsed'">
        
        <div class="chat-header" @click="expanded = !expanded">
            <div class="flex items-center gap-2">
                <i data-lucide="message-circle" class="w-5 h-5"></i>
                <span class="font-medium">Ask about the data</span>
            </div>
            <i data-lucide="chevron-up" class="w-5 h-5" x-show="expanded"></i>
            <i data-lucide="chevron-down" class="w-5 h-5" x-show="!expanded"></i>
        </div>
        
        <div x-show="expanded" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-4"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             class="chat-messages" 
             id="chat-messages">
            
            <div class="chat-message">
                <div class="message-ai">
                    Hi! I can help you analyze the voter data. Try asking questions like:
                    <ul class="mt-2 ml-4 list-disc text-sm">
                        <li>What's the voter turnout trend?</li>
                        <li>Which district has the highest turnout?</li>
                        <li>Compare turnout between elections</li>
                    </ul>
                </div>
            </div>

            <template x-for="message in messages">
                <div class="chat-message">
                    <div :class="message.type === 'user' ? 'message-user' : 'message-ai'"
                         x-text="message.text">
                    </div>
                </div>
            </template>
        </div>

        <div x-show="expanded" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-4"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             class="chat-input">
            <input type="text" 
                   id="chat-input"
                   name="chat-input"
                   placeholder="Ask a question about the data..."
                   @keyup.enter="sendMessage($event.target.value); $event.target.value = ''">
            <button class="p-2 hover:bg-surface-2 rounded-lg" 
                    @click="const input = $el.previousElementSibling; sendMessage(input.value); input.value = ''"
                    title="Send message">
                <i data-lucide="send" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <script>
        // Initialize Alpine.js
        const turnoutLegendGradient = 'background-image: linear-gradient(to right, #dc2626, #f97316, #facc15, #22c55e, #15803d)';

        const buildTooltip = (props, label = 'Turnout') => {
            const formattedTurnout = typeof props.turnout === 'number' ? props.turnout.toFixed(1) : props.turnout;
            const registered = typeof props.registered === 'number' ? props.registered.toLocaleString() : props.registered;
            const voted = typeof props.voted === 'number' ? props.voted.toLocaleString() : props.voted;
            const nonVoters = (typeof props.registered === 'number' && typeof props.voted === 'number')
                ? Math.max(props.registered - props.voted, 0).toLocaleString()
                : 'â€”';

            return `
                <div class="p-2">
                    <h4 class="font-semibold">${props.name || 'Unknown Region'}</h4>
                    <p class="text-sm">${label}: ${formattedTurnout}%</p>
                    <p class="text-sm">Registered: ${registered}</p>
                    <p class="text-sm">Voted: ${voted}</p>
                    <p class="text-sm">Non-Voters: ${nonVoters}</p>
                </div>
            `;
        };

        const rectangle = (lng1, lat1, lng2, lat2) => (
            [[
                [lng1, lat1],
                [lng1, lat2],
                [lng2, lat2],
                [lng2, lat1],
                [lng1, lat1]
            ]]
        );

        window.defaultStateKey = 'WA';
        window.stateConfigs = {
            WA: {
                label: 'Washington',
                abbr: 'WA',
                center: [-120.740135, 47.751076],
                zoom: 6,
                bounds: [[-125.0, 45.3], [-116.5, 49.2]],
                stats: {
                    registeredTotal: 247890,
                    turnoutAverage: 76,
                    newRegistrations: 1245,
                    activeAreas: 42,
                    topJurisdictions: [
                        { label: 'King County', value: 89450 },
                        { label: '7th Congressional District', value: 45230 },
                        { label: 'Seattle', value: 32180 },
                        { label: 'Bellevue', value: 28940 },
                        { label: 'Tacoma', value: 25670 }
                    ]
                }
            },
            CA: {
                label: 'California',
                abbr: 'CA',
                center: [-119.417931, 36.778259],
                zoom: 5,
                bounds: [[-125.0, 32.0], [-113.0, 42.2]],
                stats: {
                    registeredTotal: 1189050,
                    turnoutAverage: 68,
                    newRegistrations: 18230,
                    activeAreas: 120,
                    topJurisdictions: [
                        { label: 'Los Angeles County', value: 452310 },
                        { label: 'San Diego County', value: 187540 },
                        { label: 'Orange County', value: 165320 },
                        { label: 'San Francisco', value: 98650 },
                        { label: 'Sacramento County', value: 90560 }
                    ]
                }
            },
            FL: {
                label: 'Florida',
                abbr: 'FL',
                center: [-81.515753, 27.664827],
                zoom: 5.5,
                bounds: [[-88.5, 24.5], [-79.0, 31.1]],
                stats: {
                    registeredTotal: 904320,
                    turnoutAverage: 64,
                    newRegistrations: 15210,
                    activeAreas: 79,
                    topJurisdictions: [
                        { label: 'Miami-Dade County', value: 402130 },
                        { label: 'Broward County', value: 271540 },
                        { label: 'Orange County', value: 183200 },
                        { label: 'Palm Beach County', value: 176450 },
                        { label: 'Hillsborough County', value: 169820 }
                    ]
                }
            },
            OH: {
                label: 'Ohio',
                abbr: 'OH',
                center: [-82.907123, 40.417287],
                zoom: 6,
                bounds: [[-85.0, 38.0], [-80.0, 42.5]],
                stats: {
                    registeredTotal: 586320,
                    turnoutAverage: 71,
                    newRegistrations: 8230,
                    activeAreas: 48,
                    topJurisdictions: [
                        { label: 'Franklin County', value: 184560 },
                        { label: 'Cuyahoga County', value: 163420 },
                        { label: 'Hamilton County', value: 122340 },
                        { label: 'Summit County', value: 90560 },
                        { label: 'Montgomery County', value: 75800 }
                    ]
                }
            },
            DC: {
                label: 'Washington, D.C.',
                abbr: 'DC',
                center: [-77.036871, 38.907192],
                zoom: 10,
                bounds: [[-77.2, 38.8], [-76.9, 39.1]],
                stats: {
                    registeredTotal: 50340,
                    turnoutAverage: 82,
                    newRegistrations: 1240,
                    activeAreas: 8,
                    topJurisdictions: [
                        { label: 'Ward 3', value: 12840 },
                        { label: 'Ward 2', value: 11230 },
                        { label: 'Ward 6', value: 10520 },
                        { label: 'Ward 1', value: 8400 },
                        { label: 'Ward 4', value: 7370 }
                    ]
                }
            }
        };

        window.stateDatasets = {
            WA: {
                Counties: {
                    title: 'County Turnout Overview',
                    subtitle: 'Washington | November 2024',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#dc2626',
                            55, '#f97316',
                            65, '#facc15',
                            75, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.85)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'King County', turnout: 76.0, registered: 89450, voted: 67982 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.60, 47.10, -121.60, 47.90) } },
                            { type: 'Feature', properties: { name: 'Pierce County', turnout: 72.0, registered: 45230, voted: 32566 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.90, 46.70, -121.90, 47.30) } },
                            { type: 'Feature', properties: { name: 'Spokane County', turnout: 68.4, registered: 35780, voted: 24473 }, geometry: { type: 'Polygon', coordinates: rectangle(-118.40, 47.30, -117.00, 48.00) } },
                            { type: 'Feature', properties: { name: 'Clark County', turnout: 70.1, registered: 42560, voted: 29836 }, geometry: { type: 'Polygon', coordinates: rectangle(-123.15, 45.50, -122.10, 46.10) } },
                            { type: 'Feature', properties: { name: 'Whatcom County', turnout: 71.4, registered: 25670, voted: 18326 }, geometry: { type: 'Polygon', coordinates: rectangle(-123.20, 48.50, -121.90, 49.10) } }
                        ]
                    },
                    fitBounds: [[-123.5, 45.4], [-117.0, 49.2]]
                },
                Cities: {
                    title: 'City Turnout Comparison',
                    subtitle: 'Washington urban centers',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#be123c',
                            55, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            95, '#15803d'
                        ],
                        'fill-opacity': 0.8,
                        'fill-outline-color': 'rgba(15,23,42,0.25)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Seattle', turnout: 81.0, registered: 43210, voted: 35000 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.45, 47.50, -122.18, 47.75) } },
                            { type: 'Feature', properties: { name: 'Tacoma', turnout: 69.5, registered: 15280, voted: 10600 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.55, 47.18, -122.37, 47.35) } },
                            { type: 'Feature', properties: { name: 'Spokane', turnout: 66.2, registered: 12890, voted: 8540 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.50, 47.60, -117.30, 47.75) } }
                        ]
                    },
                    fitBounds: [[-123.2, 45.4], [-117.2, 48.9]]
                },
                'School Districts': {
                    title: 'School District Turnout',
                    subtitle: 'Community engagement across districts',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#991b1b',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Seattle Public Schools', turnout: 79.5, registered: 21200, voted: 16850 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.48, 47.45, -122.20, 47.75) } },
                            { type: 'Feature', properties: { name: 'Tacoma School District', turnout: 61.4, registered: 9800, voted: 6017 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.54, 47.18, -122.36, 47.32) } },
                            { type: 'Feature', properties: { name: 'Spokane School District', turnout: 63.8, registered: 11850, voted: 7560 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.54, 47.55, -117.32, 47.78) } }
                        ]
                    },
                    fitBounds: [[-123.3, 45.8], [-117.2, 48.8]]
                },
                'Legislative Districts': {
                    title: 'State Legislative Turnout',
                    subtitle: 'Washington state legislature districts',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'LD-36', turnout: 83.2, registered: 18200, voted: 15100 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.45, 47.60, -122.33, 47.70) } },
                            { type: 'Feature', properties: { name: 'LD-11', turnout: 69.4, registered: 16400, voted: 11360 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.30, 47.43, -122.10, 47.60) } },
                            { type: 'Feature', properties: { name: 'LD-04', turnout: 62.7, registered: 14320, voted: 8980 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.40, 47.55, -117.05, 47.85) } }
                        ]
                    },
                    fitBounds: [[-123.0, 45.5], [-117.0, 48.9]]
                },
                'Congressional Districts': {
                    title: 'Congressional Turnout',
                    subtitle: 'Washington federal representation',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            50, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.8)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'WA-07', turnout: 82.4, registered: 19800, voted: 16300 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.52, 47.55, -122.25, 47.75) } },
                            { type: 'Feature', properties: { name: 'WA-08', turnout: 68.9, registered: 21500, voted: 14840 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.20, 47.10, -121.20, 47.80) } },
                            { type: 'Feature', properties: { name: 'WA-05', turnout: 64.1, registered: 18750, voted: 12000 }, geometry: { type: 'Polygon', coordinates: rectangle(-118.50, 46.90, -117.00, 48.20) } }
                        ]
                    },
                    fitBounds: [[-123.3, 45.6], [-117.0, 48.3]]
                }
            },
            CA: {
                Counties: {
                    title: 'County Turnout Overview',
                    subtitle: 'California | November 2024',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#dc2626',
                            55, '#f97316',
                            65, '#facc15',
                            75, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.85)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Los Angeles County', turnout: 65.2, registered: 452310, voted: 294000 }, geometry: { type: 'Polygon', coordinates: rectangle(-118.95, 33.60, -117.60, 34.80) } },
                            { type: 'Feature', properties: { name: 'San Diego County', turnout: 72.3, registered: 187540, voted: 135400 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.60, 32.50, -116.00, 33.36) } },
                            { type: 'Feature', properties: { name: 'Orange County', turnout: 69.8, registered: 165320, voted: 116000 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.95, 33.40, -117.50, 33.95) } },
                            { type: 'Feature', properties: { name: 'Sacramento County', turnout: 70.1, registered: 90560, voted: 63500 }, geometry: { type: 'Polygon', coordinates: rectangle(-121.70, 38.20, -121.00, 38.90) } },
                            { type: 'Feature', properties: { name: 'Santa Clara County', turnout: 74.6, registered: 141230, voted: 105000 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.20, 37.00, -121.20, 37.60) } }
                        ]
                    },
                    fitBounds: [[-125.0, 32.0], [-113.0, 42.2]]
                },
                Cities: {
                    title: 'City Turnout Comparison',
                    subtitle: 'California urban centers',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#be123c',
                            55, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            95, '#15803d'
                        ],
                        'fill-opacity': 0.8,
                        'fill-outline-color': 'rgba(15,23,42,0.25)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Los Angeles', turnout: 66.0, registered: 312000, voted: 206000 }, geometry: { type: 'Polygon', coordinates: rectangle(-118.53, 33.90, -118.10, 34.20) } },
                            { type: 'Feature', properties: { name: 'San Diego', turnout: 74.1, registered: 151200, voted: 112800 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.28, 32.60, -116.90, 32.95) } },
                            { type: 'Feature', properties: { name: 'San Jose', turnout: 72.5, registered: 128400, voted: 93060 }, geometry: { type: 'Polygon', coordinates: rectangle(-121.95, 37.20, -121.70, 37.45) } },
                            { type: 'Feature', properties: { name: 'San Francisco', turnout: 78.4, registered: 98650, voted: 77300 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.53, 37.70, -122.35, 37.83) } },
                            { type: 'Feature', properties: { name: 'Sacramento', turnout: 71.3, registered: 76400, voted: 54400 }, geometry: { type: 'Polygon', coordinates: rectangle(-121.55, 38.45, -121.30, 38.70) } }
                        ]
                    },
                    fitBounds: [[-123.5, 32.5], [-117.0, 39.5]]
                },
                'School Districts': {
                    title: 'School District Turnout',
                    subtitle: 'California education regions',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#991b1b',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'LA Unified', turnout: 64.4, registered: 280000, voted: 180000 }, geometry: { type: 'Polygon', coordinates: rectangle(-118.60, 33.90, -118.00, 34.30) } },
                            { type: 'Feature', properties: { name: 'San Diego Unified', turnout: 69.8, registered: 120000, voted: 83800 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.25, 32.70, -116.90, 33.05) } },
                            { type: 'Feature', properties: { name: 'San Francisco USD', turnout: 73.2, registered: 68000, voted: 49700 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.50, 37.72, -122.36, 37.83) } },
                            { type: 'Feature', properties: { name: 'Sacramento City USD', turnout: 67.1, registered: 54000, voted: 36200 }, geometry: { type: 'Polygon', coordinates: rectangle(-121.55, 38.50, -121.30, 38.68) } }
                        ]
                    },
                    fitBounds: [[-123.4, 32.6], [-117.5, 39.2]]
                },
                'Legislative Districts': {
                    title: 'State Legislative Turnout',
                    subtitle: 'California state representation',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'SD-11', turnout: 79.4, registered: 98650, voted: 78300 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.52, 37.70, -122.35, 37.85) } },
                            { type: 'Feature', properties: { name: 'SD-39', turnout: 71.2, registered: 185300, voted: 131800 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.30, 32.75, -116.90, 33.15) } },
                            { type: 'Feature', properties: { name: 'SD-13', turnout: 74.8, registered: 161200, voted: 120600 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.40, 37.20, -121.80, 37.70) } },
                            { type: 'Feature', properties: { name: 'SD-06', turnout: 69.9, registered: 152400, voted: 106500 }, geometry: { type: 'Polygon', coordinates: rectangle(-121.70, 38.10, -120.80, 38.90) } }
                        ]
                    },
                    fitBounds: [[-123.0, 32.5], [-117.0, 39.2]]
                },
                'Congressional Districts': {
                    title: 'Congressional Turnout',
                    subtitle: 'California federal representation',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            50, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.8)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'CA-12', turnout: 77.5, registered: 98650, voted: 76450 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.52, 37.70, -122.35, 37.85) } },
                            { type: 'Feature', properties: { name: 'CA-52', turnout: 74.3, registered: 187540, voted: 139000 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.40, 32.60, -116.90, 33.25) } },
                            { type: 'Feature', properties: { name: 'CA-45', turnout: 68.2, registered: 165320, voted: 112300 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.95, 33.40, -117.60, 33.85) } },
                            { type: 'Feature', properties: { name: 'CA-07', turnout: 70.7, registered: 90560, voted: 64000 }, geometry: { type: 'Polygon', coordinates: rectangle(-121.60, 38.20, -120.90, 38.80) } }
                        ]
                    },
                    fitBounds: [[-124.3, 32.5], [-117.0, 41.5]]
                }
            },
            FL: {
                Counties: {
                    title: 'County Turnout Overview',
                    subtitle: 'Florida | November 2024',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#dc2626',
                            55, '#f97316',
                            65, '#facc15',
                            75, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.85)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Miami-Dade County', turnout: 62.4, registered: 402130, voted: 251700 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.90, 25.20, -80.10, 26.10) } },
                            { type: 'Feature', properties: { name: 'Broward County', turnout: 64.7, registered: 271540, voted: 175700 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.60, 25.80, -80.00, 26.40) } },
                            { type: 'Feature', properties: { name: 'Orange County', turnout: 68.2, registered: 183200, voted: 124600 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.60, 28.30, -80.80, 28.75) } },
                            { type: 'Feature', properties: { name: 'Palm Beach County', turnout: 66.8, registered: 176450, voted: 117200 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.80, 26.30, -80.00, 27.10) } },
                            { type: 'Feature', properties: { name: 'Hillsborough County', turnout: 67.5, registered: 169820, voted: 114800 }, geometry: { type: 'Polygon', coordinates: rectangle(-82.70, 27.60, -82.10, 28.20) } }
                        ]
                    },
                    fitBounds: [[-88.5, 24.5], [-79.0, 31.2]]
                },
                Cities: {
                    title: 'City Turnout Comparison',
                    subtitle: 'Florida urban centers',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#be123c',
                            55, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            95, '#15803d'
                        ],
                        'fill-opacity': 0.8,
                        'fill-outline-color': 'rgba(15,23,42,0.25)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Miami', turnout: 63.4, registered: 180300, voted: 114800 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.25, 25.70, -80.10, 25.90) } },
                            { type: 'Feature', properties: { name: 'Orlando', turnout: 69.9, registered: 102400, voted: 71580 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.45, 28.45, -81.25, 28.60) } },
                            { type: 'Feature', properties: { name: 'Tampa', turnout: 68.2, registered: 96400, voted: 65700 }, geometry: { type: 'Polygon', coordinates: rectangle(-82.55, 27.85, -82.35, 28.00) } },
                            { type: 'Feature', properties: { name: 'Jacksonville', turnout: 64.1, registered: 154200, voted: 98880 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.80, 30.20, -81.50, 30.45) } },
                            { type: 'Feature', properties: { name: 'Tallahassee', turnout: 67.8, registered: 51200, voted: 34770 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.35, 30.40, -84.15, 30.55) } }
                        ]
                    },
                    fitBounds: [[-82.6, 25.6], [-80.0, 30.6]]
                },
                'School Districts': {
                    title: 'School District Turnout',
                    subtitle: 'Florida education regions',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#991b1b',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Miami-Dade Public Schools', turnout: 62.8, registered: 290000, voted: 182500 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.85, 25.30, -80.10, 26.00) } },
                            { type: 'Feature', properties: { name: 'Orange County Schools', turnout: 67.5, registered: 140000, voted: 94500 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.50, 28.30, -81.00, 28.70) } },
                            { type: 'Feature', properties: { name: 'Hillsborough County Schools', turnout: 66.1, registered: 132000, voted: 87200 }, geometry: { type: 'Polygon', coordinates: rectangle(-82.60, 27.75, -82.20, 28.10) } },
                            { type: 'Feature', properties: { name: 'Broward County Schools', turnout: 64.9, registered: 165000, voted: 107000 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.45, 26.00, -80.05, 26.40) } }
                        ]
                    },
                    fitBounds: [[-82.7, 25.3], [-80.0, 30.2]]
                },
                'Legislative Districts': {
                    title: 'State Legislative Turnout',
                    subtitle: 'Florida state senate districts',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'SD-37', turnout: 64.3, registered: 190000, voted: 122000 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.40, 25.50, -80.05, 26.00) } },
                            { type: 'Feature', properties: { name: 'SD-13', turnout: 67.9, registered: 178000, voted: 121000 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.35, 28.20, -80.95, 28.70) } },
                            { type: 'Feature', properties: { name: 'SD-24', turnout: 69.1, registered: 165000, voted: 114000 }, geometry: { type: 'Polygon', coordinates: rectangle(-82.75, 27.60, -82.20, 28.15) } }
                        ]
                    },
                    fitBounds: [[-82.8, 25.4], [-80.0, 30.0]]
                },
                'Congressional Districts': {
                    title: 'Congressional Turnout',
                    subtitle: 'Florida federal representation',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            50, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.8)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'FL-25', turnout: 65.1, registered: 420000, voted: 273000 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.70, 25.30, -80.20, 26.10) } },
                            { type: 'Feature', properties: { name: 'FL-09', turnout: 67.8, registered: 315000, voted: 214000 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.45, 28.00, -81.00, 28.70) } },
                            { type: 'Feature', properties: { name: 'FL-14', turnout: 69.2, registered: 290000, voted: 201000 }, geometry: { type: 'Polygon', coordinates: rectangle(-82.60, 27.80, -82.20, 28.25) } }
                        ]
                    },
                    fitBounds: [[-82.7, 25.3], [-80.0, 30.2]]
                }
            },
            OH: {
                Counties: {
                    title: 'County Turnout Overview',
                    subtitle: 'Ohio | November 2024',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#dc2626',
                            55, '#f97316',
                            65, '#facc15',
                            75, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.85)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Franklin County', turnout: 72.4, registered: 184560, voted: 133900 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.30, 39.70, -82.70, 40.20) } },
                            { type: 'Feature', properties: { name: 'Cuyahoga County', turnout: 68.9, registered: 163420, voted: 112650 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.90, 41.20, -81.10, 41.60) } },
                            { type: 'Feature', properties: { name: 'Hamilton County', turnout: 70.5, registered: 122340, voted: 86140 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.80, 39.00, -84.20, 39.30) } },
                            { type: 'Feature', properties: { name: 'Summit County', turnout: 69.6, registered: 90560, voted: 63080 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.80, 40.95, -81.30, 41.30) } },
                            { type: 'Feature', properties: { name: 'Montgomery County', turnout: 67.8, registered: 75800, voted: 51330 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.45, 39.50, -83.90, 39.90) } }
                        ]
                    },
                    fitBounds: [[-85.0, 38.8], [-80.5, 42.5]]
                },
                Cities: {
                    title: 'City Turnout Comparison',
                    subtitle: 'Ohio urban centers',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#be123c',
                            55, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            95, '#15803d'
                        ],
                        'fill-opacity': 0.8,
                        'fill-outline-color': 'rgba(15,23,42,0.25)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Columbus', turnout: 72.8, registered: 151200, voted: 110900 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.25, 39.80, -82.75, 40.15) } },
                            { type: 'Feature', properties: { name: 'Cleveland', turnout: 67.5, registered: 128900, voted: 87000 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.77, 41.42, -81.55, 41.60) } },
                            { type: 'Feature', properties: { name: 'Cincinnati', turnout: 71.9, registered: 104500, voted: 75130 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.65, 39.05, -84.35, 39.22) } },
                            { type: 'Feature', properties: { name: 'Toledo', turnout: 66.1, registered: 78500, voted: 51830 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.67, 41.60, -83.45, 41.75) } },
                            { type: 'Feature', properties: { name: 'Dayton', turnout: 70.5, registered: 60800, voted: 42860 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.27, 39.68, -84.05, 39.92) } }
                        ]
                    },
                    fitBounds: [[-84.9, 38.6], [-81.1, 41.9]]
                },
                'School Districts': {
                    title: 'School District Turnout',
                    subtitle: 'Ohio education regions',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#991b1b',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Columbus City Schools', turnout: 71.2, registered: 118000, voted: 84000 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.20, 39.85, -82.85, 40.12) } },
                            { type: 'Feature', properties: { name: 'Cleveland Metro Schools', turnout: 66.5, registered: 96000, voted: 63800 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.75, 41.42, -81.55, 41.60) } },
                            { type: 'Feature', properties: { name: 'Cincinnati Public Schools', turnout: 69.8, registered: 78000, voted: 54500 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.60, 39.07, -84.40, 39.20) } },
                            { type: 'Feature', properties: { name: 'Toledo Public Schools', turnout: 65.2, registered: 62000, voted: 40400 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.65, 41.58, -83.45, 41.72) } }
                        ]
                    },
                    fitBounds: [[-84.8, 38.9], [-81.2, 41.8]]
                },
                'Legislative Districts': {
                    title: 'State Legislative Turnout',
                    subtitle: 'Ohio state senate districts',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'SD-03', turnout: 73.1, registered: 162000, voted: 118500 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.20, 39.90, -82.80, 40.30) } },
                            { type: 'Feature', properties: { name: 'SD-21', turnout: 68.4, registered: 154000, voted: 105400 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.85, 41.35, -81.50, 41.60) } },
                            { type: 'Feature', properties: { name: 'SD-09', turnout: 70.2, registered: 128000, voted: 89800 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.55, 39.00, -84.20, 39.30) } }
                        ]
                    },
                    fitBounds: [[-84.8, 38.9], [-81.2, 41.8]]
                },
                'Congressional Districts': {
                    title: 'Congressional Turnout',
                    subtitle: 'Ohio federal representation',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            50, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.8)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'OH-03', turnout: 73.1, registered: 162000, voted: 118500 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.20, 39.90, -82.80, 40.30) } },
                            { type: 'Feature', properties: { name: 'OH-13', turnout: 68.4, registered: 154000, voted: 105400 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.85, 41.35, -81.50, 41.60) } },
                            { type: 'Feature', properties: { name: 'OH-06', turnout: 70.2, registered: 128000, voted: 89800 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.55, 39.00, -84.20, 39.30) } }
                        ]
                    },
                    fitBounds: [[-84.8, 38.9], [-81.2, 41.8]]
                }
            },
            DC: {
                Wards: {
                    title: 'Ward Turnout Overview',
                    subtitle: 'District of Columbia wards',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#dc2626',
                            55, '#f97316',
                            65, '#facc15',
                            75, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.85)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Ward 1', turnout: 80.4, registered: 8400, voted: 6750 }, geometry: { type: 'Polygon', coordinates: rectangle(-77.04, 38.90, -77.02, 38.94) } },
                            { type: 'Feature', properties: { name: 'Ward 2', turnout: 82.7, registered: 11230, voted: 9290 }, geometry: { type: 'Polygon', coordinates: rectangle(-77.06, 38.89, -77.03, 38.92) } },
                            { type: 'Feature', properties: { name: 'Ward 3', turnout: 83.9, registered: 12840, voted: 10780 }, geometry: { type: 'Polygon', coordinates: rectangle(-77.11, 38.93, -77.05, 39.00) } },
                            { type: 'Feature', properties: { name: 'Ward 4', turnout: 81.2, registered: 7370, voted: 5985 }, geometry: { type: 'Polygon', coordinates: rectangle(-77.04, 38.95, -77.00, 39.00) } },
                            { type: 'Feature', properties: { name: 'Ward 5', turnout: 79.5, registered: 6820, voted: 5420 }, geometry: { type: 'Polygon', coordinates: rectangle(-76.99, 38.90, -76.95, 38.95) } },
                            { type: 'Feature', properties: { name: 'Ward 6', turnout: 82.1, registered: 10520, voted: 8630 }, geometry: { type: 'Polygon', coordinates: rectangle(-77.02, 38.86, -76.97, 38.90) } },
                            { type: 'Feature', properties: { name: 'Ward 7', turnout: 78.6, registered: 9230, voted: 7250 }, geometry: { type: 'Polygon', coordinates: rectangle(-76.98, 38.87, -76.94, 38.92) } },
                            { type: 'Feature', properties: { name: 'Ward 8', turnout: 76.9, registered: 8370, voted: 6435 }, geometry: { type: 'Polygon', coordinates: rectangle(-77.01, 38.84, -76.96, 38.88) } }
                        ]
                    },
                    fitBounds: [[-77.2, 38.83], [-76.9, 39.01]]
                }
            }
        };

        window.dashboardFilters = {
            state: window.defaultStateKey,
            election: 'Nov 2024',
            jurisdiction: 'Counties',
            countries: []
        };

        window.dashboardData = {
            electionModifiers: {
                'Nov 2024': 1,
                'Aug 2024': 0.93,
                'Feb 2024': 0.88,
                'Nov 2023': 0.91,
                'Aug 2023': 0.86,
                'Aug 2025': 1.05
            },
            countryOptions: [
                'Afghanistan', 'Albania', 'Algeria', 'American', 'Australia',
                'Bangladesh', 'Belize', 'Bosnia and Herzegovina', 'Brunei', 'Cham',
                'Costa Rica', 'Egypt', 'Eritrea', 'Estonia', 'Ethiopia',
                'Guatemala', 'India', 'Indonesia', 'Iran', 'Iraq',
                'Jordan', 'Kashmir', 'Lebanon', 'Mexico', 'Morocco',
                'Myanmar', 'Pakistan', 'Palestine', 'Samoa', 'Saint Vincent and the Grenadines',
                'Singapore', 'Somalia', 'South Africa', 'Sudan', 'Syria',
                'Thailand', 'Tunisia', 'Turkey', 'Viet Nam', 'Yemen'
            ],
            baseCountries: [
                { name: 'Morocco', turnout: 100.0, total: 18 },
                { name: 'Kashmir', turnout: 88.9, total: 20 },
                { name: 'India', turnout: 82.3, total: 214 },
                { name: 'Egypt', turnout: 80.0, total: 116 },
                { name: 'American', turnout: 74.9, total: 892 },
                { name: 'Turkey', turnout: 69.0, total: 3716 },
                { name: 'Bosnia and Herzegovina', turnout: 68.9, total: 5678 },
                { name: 'Palestine', turnout: 68.7, total: 1432 },
                { name: 'Pakistan', turnout: 68.2, total: 2891 },
                { name: 'Bangladesh', turnout: 66.9, total: 1567 },
                { name: 'Sudan', turnout: 59.8, total: 789 },
                { name: 'Syria', turnout: 58.3, total: 654 },
                { name: 'Iraq', turnout: 55.6, total: 987 },
                { name: 'Iran', turnout: 55.5, total: 1234 },
                { name: 'Cham', turnout: 55.2, total: 432 },
                { name: 'Eritrea', turnout: 50.2, total: 321 },
                { name: 'Lebanon', turnout: 44.2, total: 876 },
                { name: 'Afghanistan', turnout: 41.4, total: 543 },
                { name: 'Ethiopia', turnout: 41.2, total: 765 },
                { name: 'Somalia', turnout: 29.1, total: 234 }
            ]
        };

        window.stateBaseStats = {};
        Object.entries(window.stateConfigs).forEach(([key, config]) => {
            if (config?.stats) {
                window.stateBaseStats[key] = JSON.parse(JSON.stringify(config.stats));
            }
        });

        const clampValue = (value, min, max) => Math.min(Math.max(value, min), max);

        window.getElectionModifier = (election) => {
            return window.dashboardData.electionModifiers[election] ?? 1;
        };

        window.computeCountryMetrics = (filters = window.dashboardFilters) => {
            const modifier = window.getElectionModifier(filters?.election);
            const baseList = window.dashboardData.baseCountries;
            const selectedCountries = Array.isArray(filters?.countries)
                ? filters.countries.filter(Boolean)
                : [];

            let selected = selectedCountries.length
                ? baseList.filter(item => selectedCountries.includes(item.name))
                : baseList.slice(0, 12);

            if (!selected.length) {
                selected = baseList.slice(0, 12);
            }

            const adjustedList = selected.map(item => {
                const isFocused = selectedCountries.includes(item.name);
                const focusBoost = isFocused ? 1.05 : 1;
                const turnout = clampValue(item.turnout * modifier * focusBoost, 20, 100);
                const total = Math.round(item.total * (0.9 + modifier * 0.15) * focusBoost);
                return {
                    name: item.name,
                    turnout: Number(turnout.toFixed(1)),
                    total
                };
            });

            const totalVoters = adjustedList.reduce((sum, item) => sum + item.total, 0) || 1;
            const listWithShare = adjustedList.map(item => ({
                ...item,
                share: Number(((item.total / totalVoters) * 100).toFixed(1))
            }));

            const avgTurnout = listWithShare.reduce((sum, item) => sum + item.turnout, 0) / (listWithShare.length || 1);

            return {
                list: listWithShare,
                totalVoters,
                averageTurnout: Number(avgTurnout.toFixed(1))
            };
        };

        window.cloneGeoJSON = (data) => {
            if (!data) return null;
            return typeof structuredClone === 'function'
                ? structuredClone(data)
                : JSON.parse(JSON.stringify(data));
        };

        window.getFilteredDatasetData = (stateKey, datasetKey, filters = window.dashboardFilters) => {
            const stateData = window.stateDatasets[stateKey];
            const dataset = stateData?.[datasetKey];
            if (!dataset?.data) return null;

            const cloned = window.cloneGeoJSON(dataset.data);
            const electionModifier = window.getElectionModifier(filters.election);
            const countryImpact = filters.countries?.length ? 1 + (filters.countries.length * 0.012) : 1;
            const combinedModifier = electionModifier * countryImpact;

            cloned.features = cloned.features.map(feature => {
                const updated = window.cloneGeoJSON(feature);
                const props = updated.properties || {};
                const baseRegistered = props.registered ?? props.total ?? 0;
                const registered = baseRegistered ? Math.round(baseRegistered * (0.9 + combinedModifier * 0.15)) : baseRegistered;
                const baseTurnout = props.turnout ?? (props.voted && baseRegistered ? (props.voted / baseRegistered) * 100 : 60);
                const turnout = clampValue(baseTurnout * combinedModifier, 15, 99);
                const voted = registered ? Math.round(registered * (turnout / 100)) : props.voted ?? 0;

                updated.properties = {
                    ...props,
                    turnout: Number(turnout.toFixed(1)),
                    registered,
                    voted,
                    nonVoters: registered && voted ? Math.max(registered - voted, 0) : undefined
                };

                return updated;
            });

            return cloned;
        };

        window.computeStateStats = (stateKey, filters = window.dashboardFilters, countryMetrics = null) => {
            const baseStats = window.stateBaseStats[stateKey];
            if (!baseStats) {
                return {
                    registeredTotal: 0,
                    turnoutAverage: 0,
                    newRegistrations: 0,
                    activeAreas: 0
                };
            }

            const electionModifier = window.getElectionModifier(filters.election);
            const avgCountryTurnout = countryMetrics?.averageTurnout || baseStats.turnoutAverage;
            const countryModifier = avgCountryTurnout ? clampValue(avgCountryTurnout / 75, 0.7, 1.25) : 1;
            const combined = electionModifier * countryModifier;

            const registeredTotal = Math.round(baseStats.registeredTotal * (0.92 + combined * 0.18));
            const turnoutAverage = clampValue(baseStats.turnoutAverage * (0.85 + combined * 0.18), 35, 96);
            const newRegistrations = Math.round(baseStats.newRegistrations * (0.9 + combined * 0.2));
            const activeAreas = Math.round(baseStats.activeAreas * (0.9 + electionModifier * 0.15));

            return {
                registeredTotal,
                turnoutAverage: Number(turnoutAverage.toFixed(1)),
                newRegistrations,
                activeAreas
            };
        };

        window.computeTopJurisdictions = (stateKey, filters = window.dashboardFilters) => {
            const data = window.getFilteredDatasetData(stateKey, filters.jurisdiction, filters);
            if (!data?.features?.length) return [];

            const sorted = data.features
                .map(feature => ({
                    name: feature.properties?.name || 'Unknown',
                    voted: feature.properties?.voted ?? 0,
                    registered: feature.properties?.registered ?? 0
                }))
                .sort((a, b) => (b.voted || b.registered) - (a.voted || a.registered));

            const top = sorted.slice(0, 5);
            const maxValue = top[0]?.voted || top[0]?.registered || 1;

            return top.map(item => ({
                label: item.name,
                value: item.voted || item.registered,
                pct: maxValue ? clampValue(Math.round(((item.voted || item.registered) / maxValue) * 100), 5, 100) : 0
            }));
        };

        window.computeGaugeMetrics = (stateStats) => {
            const turnout = stateStats?.turnoutAverage ?? 0;
            const totalEligible = stateStats?.registeredTotal ?? 0;
            const totalVoted = Math.round(totalEligible * (turnout / 100));

            return {
                turnout: Number(turnout.toFixed(1)),
                totalEligible,
                totalVoted
            };
        };

        window.dashboardMetrics = {
            filters: { ...window.dashboardFilters },
            stats: null,
            gauge: null,
            countries: null,
            topJurisdictions: []
        };

        window.applyDashboardFilters = (overrideFilters = {}) => {
            window.dashboardFilters = {
                ...window.dashboardFilters,
                ...overrideFilters
            };

            const filters = window.dashboardFilters;
            window.dashboardMetrics.filters = { ...filters };

            window.currentStateKey = filters.state;
            window.updateStateMap(filters.state, filters);
            window.updateStateStats(filters.state, filters, window.dashboardMetrics);

            if (window.turnoutBarChart) {
                const modifiers = window.dashboardData.electionModifiers;
                const allElections = ['Aug 2025', 'Nov 2024', 'Aug 2024', 'Feb 2024', 'Nov 2023', 'Aug 2023'];
                const baseline = [60, 74, 68, 58, 66, 61];
                window.turnoutBarChart.data.datasets[0].data = allElections.map((key, idx) => {
                    const base = baseline[idx] || 60;
                    const modifier = modifiers[key] ?? 1;
                    return Math.round(base * modifier);
                });
                window.turnoutBarChart.data.datasets[0].backgroundColor = allElections.map(election =>
                    election === filters.election ? '#1d4ed8' : '#2563eb'
                );
                window.turnoutBarChart.update();
            }

            if (window.choroplethMapInstance) {
                const datasetKey = filters.jurisdiction;
                const stateData = window.stateDatasets[filters.state];
                if (stateData?.[datasetKey]) {
                    const source = window.choroplethMapInstance.getSource('voter-data');
                    if (source) {
                        const filteredGeoJson = window.getFilteredDatasetData(filters.state, datasetKey, filters);
                        source.setData(filteredGeoJson);
                    }
                }
            }

            if (window.expandedMapInstance) {
                const datasetKey = filters.jurisdiction;
                const stateData = window.stateDatasets[filters.state];
                if (stateData?.[datasetKey]) {
                    const source = window.expandedMapInstance.getSource('voter-data');
                    if (source) {
                        const filteredGeoJson = window.getFilteredDatasetData(filters.state, datasetKey, filters);
                        source.setData(filteredGeoJson);
                    }
                }
            }

            const filtersEvent = new CustomEvent('dashboard:update', {
                detail: {
                    filters: { ...filters },
                    metrics: { ...window.dashboardMetrics }
                }
            });
            window.dispatchEvent(filtersEvent);
        };

        window.addEventListener('DOMContentLoaded', () => {
            window.applyDashboardFilters({});
        });

        window.stateDatasets = {
            WA: {
                Counties: {
                    title: 'County Turnout Overview',
                    subtitle: 'Washington | November 2024',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#dc2626',
                            55, '#f97316',
                            65, '#facc15',
                            75, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.85)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'King County', turnout: 76.0, registered: 89450, voted: 67982 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.60, 47.10, -121.60, 47.90) } },
                            { type: 'Feature', properties: { name: 'Pierce County', turnout: 72.0, registered: 45230, voted: 32566 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.90, 46.70, -121.90, 47.30) } },
                            { type: 'Feature', properties: { name: 'Spokane County', turnout: 68.4, registered: 35780, voted: 24473 }, geometry: { type: 'Polygon', coordinates: rectangle(-118.40, 47.30, -117.00, 48.00) } },
                            { type: 'Feature', properties: { name: 'Clark County', turnout: 70.1, registered: 42560, voted: 29836 }, geometry: { type: 'Polygon', coordinates: rectangle(-123.15, 45.50, -122.10, 46.10) } },
                            { type: 'Feature', properties: { name: 'Whatcom County', turnout: 71.4, registered: 25670, voted: 18326 }, geometry: { type: 'Polygon', coordinates: rectangle(-123.20, 48.50, -121.90, 49.10) } }
                        ]
                    },
                    fitBounds: [[-123.5, 45.4], [-117.0, 49.2]]
                },
                Cities: {
                    title: 'City Turnout Comparison',
                    subtitle: 'Washington urban centers',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#be123c',
                            55, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            95, '#15803d'
                        ],
                        'fill-opacity': 0.8,
                        'fill-outline-color': 'rgba(15,23,42,0.25)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Seattle', turnout: 81.0, registered: 43210, voted: 35000 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.45, 47.50, -122.18, 47.75) } },
                            { type: 'Feature', properties: { name: 'Tacoma', turnout: 69.5, registered: 15280, voted: 10600 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.55, 47.18, -122.37, 47.35) } },
                            { type: 'Feature', properties: { name: 'Spokane', turnout: 66.2, registered: 12890, voted: 8540 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.50, 47.60, -117.30, 47.75) } }
                        ]
                    },
                    fitBounds: [[-123.2, 45.4], [-117.2, 48.9]]
                },
                'School Districts': {
                    title: 'School District Turnout',
                    subtitle: 'Community engagement across districts',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#991b1b',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Seattle Public Schools', turnout: 79.5, registered: 21200, voted: 16850 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.48, 47.45, -122.20, 47.75) } },
                            { type: 'Feature', properties: { name: 'Tacoma School District', turnout: 61.4, registered: 9800, voted: 6017 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.54, 47.18, -122.36, 47.32) } },
                            { type: 'Feature', properties: { name: 'Spokane School District', turnout: 63.8, registered: 11850, voted: 7560 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.54, 47.55, -117.32, 47.78) } }
                        ]
                    },
                    fitBounds: [[-123.3, 45.8], [-117.2, 48.8]]
                },
                'Legislative Districts': {
                    title: 'State Legislative Turnout',
                    subtitle: 'Washington state legislature districts',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'LD-36', turnout: 83.2, registered: 18200, voted: 15100 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.45, 47.60, -122.33, 47.70) } },
                            { type: 'Feature', properties: { name: 'LD-11', turnout: 69.4, registered: 16400, voted: 11360 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.30, 47.43, -122.10, 47.60) } },
                            { type: 'Feature', properties: { name: 'LD-04', turnout: 62.7, registered: 14320, voted: 8980 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.40, 47.55, -117.05, 47.85) } }
                        ]
                    },
                    fitBounds: [[-123.0, 45.5], [-117.0, 48.9]]
                },
                'Congressional Districts': {
                    title: 'Congressional Turnout',
                    subtitle: 'Washington federal representation',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            50, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.8)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'WA-07', turnout: 82.4, registered: 19800, voted: 16300 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.52, 47.55, -122.25, 47.75) } },
                            { type: 'Feature', properties: { name: 'WA-08', turnout: 68.9, registered: 21500, voted: 14840 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.20, 47.10, -121.20, 47.80) } },
                            { type: 'Feature', properties: { name: 'WA-05', turnout: 64.1, registered: 18750, voted: 12000 }, geometry: { type: 'Polygon', coordinates: rectangle(-118.50, 46.90, -117.00, 48.20) } }
                        ]
                    },
                    fitBounds: [[-123.3, 45.6], [-117.0, 48.3]]
                }
            },
            CA: {
                Counties: {
                    title: 'County Turnout Overview',
                    subtitle: 'California | November 2024',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#dc2626',
                            55, '#f97316',
                            65, '#facc15',
                            75, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.85)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Los Angeles County', turnout: 65.2, registered: 452310, voted: 294000 }, geometry: { type: 'Polygon', coordinates: rectangle(-118.95, 33.60, -117.60, 34.80) } },
                            { type: 'Feature', properties: { name: 'San Diego County', turnout: 72.3, registered: 187540, voted: 135400 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.60, 32.50, -116.00, 33.36) } },
                            { type: 'Feature', properties: { name: 'Orange County', turnout: 69.8, registered: 165320, voted: 116000 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.95, 33.40, -117.50, 33.95) } },
                            { type: 'Feature', properties: { name: 'Sacramento County', turnout: 70.1, registered: 90560, voted: 63500 }, geometry: { type: 'Polygon', coordinates: rectangle(-121.70, 38.20, -121.00, 38.90) } },
                            { type: 'Feature', properties: { name: 'Santa Clara County', turnout: 74.6, registered: 141230, voted: 105000 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.20, 37.00, -121.20, 37.60) } }
                        ]
                    },
                    fitBounds: [[-125.0, 32.0], [-113.0, 42.2]]
                },
                Cities: {
                    title: 'City Turnout Comparison',
                    subtitle: 'California urban centers',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#be123c',
                            55, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            95, '#15803d'
                        ],
                        'fill-opacity': 0.8,
                        'fill-outline-color': 'rgba(15,23,42,0.25)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Los Angeles', turnout: 66.0, registered: 312000, voted: 206000 }, geometry: { type: 'Polygon', coordinates: rectangle(-118.53, 33.90, -118.10, 34.20) } },
                            { type: 'Feature', properties: { name: 'San Diego', turnout: 74.1, registered: 151200, voted: 112800 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.28, 32.60, -116.90, 32.95) } },
                            { type: 'Feature', properties: { name: 'San Jose', turnout: 72.5, registered: 128400, voted: 93060 }, geometry: { type: 'Polygon', coordinates: rectangle(-121.95, 37.20, -121.70, 37.45) } },
                            { type: 'Feature', properties: { name: 'San Francisco', turnout: 78.4, registered: 98650, voted: 77300 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.53, 37.70, -122.35, 37.83) } },
                            { type: 'Feature', properties: { name: 'Sacramento', turnout: 71.3, registered: 76400, voted: 54400 }, geometry: { type: 'Polygon', coordinates: rectangle(-121.55, 38.45, -121.30, 38.70) } }
                        ]
                    },
                    fitBounds: [[-123.5, 32.5], [-117.0, 39.5]]
                },
                'School Districts': {
                    title: 'School District Turnout',
                    subtitle: 'California education regions',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#991b1b',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'LA Unified', turnout: 64.4, registered: 280000, voted: 180000 }, geometry: { type: 'Polygon', coordinates: rectangle(-118.60, 33.90, -118.00, 34.30) } },
                            { type: 'Feature', properties: { name: 'San Diego Unified', turnout: 69.8, registered: 120000, voted: 83800 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.25, 32.70, -116.90, 33.05) } },
                            { type: 'Feature', properties: { name: 'San Francisco USD', turnout: 73.2, registered: 68000, voted: 49700 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.50, 37.72, -122.36, 37.83) } },
                            { type: 'Feature', properties: { name: 'Sacramento City USD', turnout: 67.1, registered: 54000, voted: 36200 }, geometry: { type: 'Polygon', coordinates: rectangle(-121.55, 38.50, -121.30, 38.68) } }
                        ]
                    },
                    fitBounds: [[-123.4, 32.6], [-117.5, 39.2]]
                },
                'Legislative Districts': {
                    title: 'State Legislative Turnout',
                    subtitle: 'California state representation',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'SD-11', turnout: 79.4, registered: 98650, voted: 78300 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.52, 37.70, -122.35, 37.85) } },
                            { type: 'Feature', properties: { name: 'SD-39', turnout: 71.2, registered: 185300, voted: 131800 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.30, 32.75, -116.90, 33.15) } },
                            { type: 'Feature', properties: { name: 'SD-13', turnout: 74.8, registered: 161200, voted: 120600 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.40, 37.20, -121.80, 37.70) } },
                            { type: 'Feature', properties: { name: 'SD-06', turnout: 69.9, registered: 152400, voted: 106500 }, geometry: { type: 'Polygon', coordinates: rectangle(-121.70, 38.10, -120.80, 38.90) } }
                        ]
                    },
                    fitBounds: [[-123.0, 32.5], [-117.0, 39.2]]
                },
                'Congressional Districts': {
                    title: 'Congressional Turnout',
                    subtitle: 'California federal representation',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            50, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.8)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'CA-12', turnout: 77.5, registered: 98650, voted: 76450 }, geometry: { type: 'Polygon', coordinates: rectangle(-122.52, 37.70, -122.35, 37.85) } },
                            { type: 'Feature', properties: { name: 'CA-52', turnout: 74.3, registered: 187540, voted: 139000 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.40, 32.60, -116.90, 33.25) } },
                            { type: 'Feature', properties: { name: 'CA-45', turnout: 68.2, registered: 165320, voted: 112300 }, geometry: { type: 'Polygon', coordinates: rectangle(-117.95, 33.40, -117.60, 33.85) } },
                            { type: 'Feature', properties: { name: 'CA-07', turnout: 70.7, registered: 90560, voted: 64000 }, geometry: { type: 'Polygon', coordinates: rectangle(-121.60, 38.20, -120.90, 38.80) } }
                        ]
                    },
                    fitBounds: [[-124.3, 32.5], [-117.0, 41.5]]
                }
            },
            FL: {
                Counties: {
                    title: 'County Turnout Overview',
                    subtitle: 'Florida | November 2024',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#dc2626',
                            55, '#f97316',
                            65, '#facc15',
                            75, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.85)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Miami-Dade County', turnout: 62.4, registered: 402130, voted: 251700 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.90, 25.20, -80.10, 26.10) } },
                            { type: 'Feature', properties: { name: 'Broward County', turnout: 64.7, registered: 271540, voted: 175700 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.60, 25.80, -80.00, 26.40) } },
                            { type: 'Feature', properties: { name: 'Orange County', turnout: 68.2, registered: 183200, voted: 124600 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.60, 28.30, -80.80, 28.75) } },
                            { type: 'Feature', properties: { name: 'Palm Beach County', turnout: 66.8, registered: 176450, voted: 117200 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.80, 26.30, -80.00, 27.10) } },
                            { type: 'Feature', properties: { name: 'Hillsborough County', turnout: 67.5, registered: 169820, voted: 114800 }, geometry: { type: 'Polygon', coordinates: rectangle(-82.70, 27.60, -82.10, 28.20) } }
                        ]
                    },
                    fitBounds: [[-88.5, 24.5], [-79.0, 31.2]]
                },
                Cities: {
                    title: 'City Turnout Comparison',
                    subtitle: 'Florida urban centers',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#be123c',
                            55, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            95, '#15803d'
                        ],
                        'fill-opacity': 0.8,
                        'fill-outline-color': 'rgba(15,23,42,0.25)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Miami', turnout: 63.4, registered: 180300, voted: 114800 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.25, 25.70, -80.10, 25.90) } },
                            { type: 'Feature', properties: { name: 'Orlando', turnout: 69.9, registered: 102400, voted: 71580 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.45, 28.45, -81.25, 28.60) } },
                            { type: 'Feature', properties: { name: 'Tampa', turnout: 68.2, registered: 96400, voted: 65700 }, geometry: { type: 'Polygon', coordinates: rectangle(-82.55, 27.85, -82.35, 28.00) } },
                            { type: 'Feature', properties: { name: 'Jacksonville', turnout: 64.1, registered: 154200, voted: 98880 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.80, 30.20, -81.50, 30.45) } },
                            { type: 'Feature', properties: { name: 'Tallahassee', turnout: 67.8, registered: 51200, voted: 34770 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.35, 30.40, -84.15, 30.55) } }
                        ]
                    },
                    fitBounds: [[-82.6, 25.6], [-80.0, 30.6]]
                },
                'School Districts': {
                    title: 'School District Turnout',
                    subtitle: 'Florida education regions',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#991b1b',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Miami-Dade Public Schools', turnout: 62.8, registered: 290000, voted: 182500 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.85, 25.30, -80.10, 26.00) } },
                            { type: 'Feature', properties: { name: 'Orange County Schools', turnout: 67.5, registered: 140000, voted: 94500 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.50, 28.30, -81.00, 28.70) } },
                            { type: 'Feature', properties: { name: 'Hillsborough County Schools', turnout: 66.1, registered: 132000, voted: 87200 }, geometry: { type: 'Polygon', coordinates: rectangle(-82.60, 27.75, -82.20, 28.10) } },
                            { type: 'Feature', properties: { name: 'Broward County Schools', turnout: 64.9, registered: 165000, voted: 107000 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.45, 26.00, -80.05, 26.40) } }
                        ]
                    },
                    fitBounds: [[-82.7, 25.3], [-80.0, 30.2]]
                },
                'Legislative Districts': {
                    title: 'State Legislative Turnout',
                    subtitle: 'Florida state senate districts',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'SD-37', turnout: 64.3, registered: 190000, voted: 122000 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.40, 25.50, -80.05, 26.00) } },
                            { type: 'Feature', properties: { name: 'SD-13', turnout: 67.9, registered: 178000, voted: 121000 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.35, 28.20, -80.95, 28.70) } },
                            { type: 'Feature', properties: { name: 'SD-24', turnout: 69.1, registered: 165000, voted: 114000 }, geometry: { type: 'Polygon', coordinates: rectangle(-82.75, 27.60, -82.20, 28.15) } }
                        ]
                    },
                    fitBounds: [[-82.8, 25.4], [-80.0, 30.0]]
                },
                'Congressional Districts': {
                    title: 'Congressional Turnout',
                    subtitle: 'Florida federal representation',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            50, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.8)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'FL-25', turnout: 65.1, registered: 420000, voted: 273000 }, geometry: { type: 'Polygon', coordinates: rectangle(-80.70, 25.30, -80.20, 26.10) } },
                            { type: 'Feature', properties: { name: 'FL-09', turnout: 67.8, registered: 315000, voted: 214000 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.45, 28.00, -81.00, 28.70) } },
                            { type: 'Feature', properties: { name: 'FL-14', turnout: 69.2, registered: 290000, voted: 201000 }, geometry: { type: 'Polygon', coordinates: rectangle(-82.60, 27.80, -82.20, 28.25) } }
                        ]
                    },
                    fitBounds: [[-82.7, 25.3], [-80.0, 30.2]]
                }
            },
            OH: {
                Counties: {
                    title: 'County Turnout Overview',
                    subtitle: 'Ohio | November 2024',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#dc2626',
                            55, '#f97316',
                            65, '#facc15',
                            75, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.85)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Franklin County', turnout: 72.4, registered: 184560, voted: 133900 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.30, 39.70, -82.70, 40.20) } },
                            { type: 'Feature', properties: { name: 'Cuyahoga County', turnout: 68.9, registered: 163420, voted: 112650 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.90, 41.20, -81.10, 41.60) } },
                            { type: 'Feature', properties: { name: 'Hamilton County', turnout: 70.5, registered: 122340, voted: 86140 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.80, 39.00, -84.20, 39.30) } },
                            { type: 'Feature', properties: { name: 'Summit County', turnout: 69.6, registered: 90560, voted: 63080 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.80, 40.95, -81.30, 41.30) } },
                            { type: 'Feature', properties: { name: 'Montgomery County', turnout: 67.8, registered: 75800, voted: 51330 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.45, 39.50, -83.90, 39.90) } }
                        ]
                    },
                    fitBounds: [[-85.0, 38.8], [-80.5, 42.5]]
                },
                Cities: {
                    title: 'City Turnout Comparison',
                    subtitle: 'Ohio urban centers',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#be123c',
                            55, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            95, '#15803d'
                        ],
                        'fill-opacity': 0.8,
                        'fill-outline-color': 'rgba(15,23,42,0.25)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Columbus', turnout: 72.8, registered: 151200, voted: 110900 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.25, 39.80, -82.75, 40.15) } },
                            { type: 'Feature', properties: { name: 'Cleveland', turnout: 67.5, registered: 128900, voted: 87000 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.77, 41.42, -81.55, 41.60) } },
                            { type: 'Feature', properties: { name: 'Cincinnati', turnout: 71.9, registered: 104500, voted: 75130 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.65, 39.05, -84.35, 39.22) } },
                            { type: 'Feature', properties: { name: 'Toledo', turnout: 66.1, registered: 78500, voted: 51830 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.67, 41.60, -83.45, 41.75) } },
                            { type: 'Feature', properties: { name: 'Dayton', turnout: 70.5, registered: 60800, voted: 42860 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.27, 39.68, -84.05, 39.92) } }
                        ]
                    },
                    fitBounds: [[-84.9, 38.6], [-81.1, 41.9]]
                },
                'School Districts': {
                    title: 'School District Turnout',
                    subtitle: 'Ohio education regions',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#991b1b',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'Columbus City Schools', turnout: 71.2, registered: 118000, voted: 84000 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.20, 39.85, -82.85, 40.12) } },
                            { type: 'Feature', properties: { name: 'Cleveland Metro Schools', turnout: 66.5, registered: 96000, voted: 63800 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.75, 41.42, -81.55, 41.60) } },
                            { type: 'Feature', properties: { name: 'Cincinnati Public Schools', turnout: 69.8, registered: 78000, voted: 54500 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.60, 39.07, -84.40, 39.20) } },
                            { type: 'Feature', properties: { name: 'Toledo Public Schools', turnout: 65.2, registered: 62000, voted: 40400 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.65, 41.58, -83.45, 41.72) } }
                        ]
                    },
                    fitBounds: [[-84.8, 38.9], [-81.2, 41.8]]
                },
                'Legislative Districts': {
                    title: 'State Legislative Turnout',
                    subtitle: 'Ohio state senate districts',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            45, '#f97316',
                            60, '#facc15',
                            75, '#16a34a',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.75)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'SD-03', turnout: 73.1, registered: 162000, voted: 118500 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.20, 39.90, -82.80, 40.30) } },
                            { type: 'Feature', properties: { name: 'SD-21', turnout: 68.4, registered: 154000, voted: 105400 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.85, 41.35, -81.50, 41.60) } },
                            { type: 'Feature', properties: { name: 'SD-09', turnout: 70.2, registered: 128000, voted: 89800 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.55, 39.00, -84.20, 39.30) } }
                        ]
                    },
                    fitBounds: [[-84.8, 38.9], [-81.2, 41.8]]
                },
                'Congressional Districts': {
                    title: 'Congressional Turnout',
                    subtitle: 'Ohio federal representation',
                    legend: {
                        range: '0-100%',
                        gradient: turnoutLegendGradient
                    },
                    tooltipKey: 'name',
                    tooltipTemplate: (props) => buildTooltip(props, 'Turnout'),
                    paint: {
                        'fill-color': [
                            'interpolate', ['linear'], ['get', 'turnout'],
                            0, '#7f1d1d',
                            50, '#f97316',
                            65, '#facc15',
                            80, '#22c55e',
                            90, '#15803d'
                        ],
                        'fill-opacity': 0.78,
                        'fill-outline-color': 'rgba(255,255,255,0.8)'
                    },
                    data: {
                        type: 'FeatureCollection',
                        features: [
                            { type: 'Feature', properties: { name: 'OH-03', turnout: 73.1, registered: 162000, voted: 118500 }, geometry: { type: 'Polygon', coordinates: rectangle(-83.20, 39.90, -82.80, 40.30) } },
                            { type: 'Feature', properties: { name: 'OH-13', turnout: 68.4, registered: 154000, voted: 105400 }, geometry: { type: 'Polygon', coordinates: rectangle(-81.85, 41.35, -81.50, 41.60) } },
                            { type: 'Feature', properties: { name: 'OH-06', turnout: 70.2, registered: 128000, voted: 89800 }, geometry: { type: 'Polygon', coordinates: rectangle(-84.55, 39.00, -84.20, 39.30) } }
                        ]
                    },
                    fitBounds: [[-84.8, 38.9], [-81.2, 41.8]]
                }
            },
            DC: {
                label: 'Washington, D.C.',
                abbr: 'DC',
                center: [-77.036871, 38.907192],
                zoom: 10,
                bounds: [[-77.2, 38.8], [-76.9, 39.1]],
                stats: {
                    registeredTotal: 50340,
                    turnoutAverage: 82,
                    newRegistrations: 1240,
                    activeAreas: 8,
                    topJurisdictions: [
                        { label: 'Ward 3', value: 12840 },
                        { label: 'Ward 2', value: 11230 },
                        { label: 'Ward 6', value: 10520 },
                        { label: 'Ward 1', value: 8400 },
                        { label: 'Ward 4', value: 7370 }
                    ]
                }
            }
        };

        window.currentStateKey = window.defaultStateKey;
        window.choroplethDatasets = window.stateDatasets[window.currentStateKey];
        window.currentDatasetKey = 'Counties';
        window.choroplethMapInstance = null;
        window.expandedMapInstance = null;

        window.updateStateStats = (stateKey, filters = window.dashboardFilters, metrics = window.dashboardMetrics) => {
            const config = window.stateConfigs[stateKey];
            if (!config) return;

            const countryMetrics = metrics?.countries || window.computeCountryMetrics(filters);
            const stateStats = window.computeStateStats(stateKey, filters, countryMetrics);
            const { registeredTotal, turnoutAverage, newRegistrations, activeAreas } = stateStats;

            const registeredEl = document.querySelector('[data-stat="registered-total"]');
            if (registeredEl) registeredEl.textContent = registeredTotal?.toLocaleString() ?? '0';

            const turnoutEl = document.querySelector('[data-stat="turnout-average"]');
            if (turnoutEl) turnoutEl.textContent = `${(turnoutAverage ?? 0)}%`;

            const newRegEl = document.querySelector('[data-stat="new-registrations"]');
            if (newRegEl) newRegEl.textContent = newRegistrations?.toLocaleString() ?? '0';

            const activeAreasEl = document.querySelector('[data-stat="active-areas"]');
            if (activeAreasEl) activeAreasEl.textContent = activeAreas?.toLocaleString() ?? '0';

            const topJurisdictions = window.computeTopJurisdictions(stateKey, filters);
            topJurisdictions.forEach(({ label, value, pct }, index) => {
                const valueEl = document.querySelector(`[data-stat="top-jurisdiction-${index}"]`);
                if (valueEl) valueEl.textContent = value?.toLocaleString() ?? '0';

                const labelEl = document.querySelector(`[data-top-label="${index}"]`);
                if (labelEl) labelEl.textContent = label ?? 'â€”';

                const progressEl = document.querySelector(`[data-top-progress="${index}"]`);
                if (progressEl) {
                    progressEl.style.width = `${pct ?? 0}%`;
                }
            });

            const gaugeMetrics = window.computeGaugeMetrics(stateStats);
            window.dashboardMetrics = {
                filters: { ...filters },
                stats: stateStats,
                gauge: gaugeMetrics,
                countries: countryMetrics,
                topJurisdictions
            };

            const gaugeWidget = document.querySelector('[x-data^="turnoutGaugeWidget"]');
            if (gaugeWidget && gaugeWidget.__x) {
                gaugeWidget.__x.$data.turnout = gaugeMetrics.turnout;
                gaugeWidget.__x.$data.totalEligible = gaugeMetrics.totalEligible;
                gaugeWidget.__x.$data.totalVoted = gaugeMetrics.totalVoted;
            }

            const option1Widget = document.querySelector('[x-data*="sortedCountries"]');
            if (option1Widget && option1Widget.__x) {
                const countriesList = countryMetrics.list ?? [];
                option1Widget.__x.$data.countries = countriesList.map(item => ({
                    name: item.name,
                    turnout: item.turnout,
                    total: item.total,
                    share: item.share
                }));
            }

            if (window.ethnicityChart && countryMetrics.list.length) {
                const chartData = countryMetrics.list.map(item => item.share);
                const chartLabels = countryMetrics.list.map(item => item.name);
                window.ethnicityChart.data.labels = chartLabels;
                window.ethnicityChart.data.datasets[0].data = chartData;
                window.ethnicityChart.update();
            }

            if (window.futuristicCountryChart && countryMetrics.list.length) {
                const list = countryMetrics.list;
                window.futuristicCountryChart.data.labels = list.map(item => item.name);
                window.futuristicCountryChart.data.datasets[0].data = list.map(item => item.turnout);
                window.futuristicCountryChart.data.datasets[0].totalValues = list.map(item => item.total);
                window.futuristicCountryChart.update();
            }

            const topList = topJurisdictions;
            topList.forEach((item, index) => {
                const labelEl = document.querySelector(`[data-top-label="${index}"]`);
                if (labelEl) labelEl.textContent = item.label;
                const valueEl = document.querySelector(`[data-stat="top-jurisdiction-${index}"]`);
                if (valueEl) valueEl.textContent = item.value.toLocaleString();
                const progressEl = document.querySelector(`[data-top-progress="${index}"]`);
                if (progressEl) progressEl.style.width = `${item.pct}%`;
            });
        };

        window.updateStateMap = (stateKey, filters = window.dashboardFilters) => {
            const stateData = window.stateDatasets[stateKey];
            if (!stateData) return;

            window.choroplethDatasets = stateData;

            const datasetKey = filters.jurisdiction && stateData[filters.jurisdiction]
                ? filters.jurisdiction
                : 'Counties';

            if (window.updateChoroplethView) {
                window.updateChoroplethView(datasetKey);
            }

            const config = window.stateConfigs[stateKey];
            if (config?.bounds) {
                [window.choroplethMapInstance, window.expandedMapInstance]
                    .filter(Boolean)
                    .forEach(map => {
                        try {
                            map.fitBounds(config.bounds, { padding: 30, maxZoom: 8 });
                        } catch (error) {
                            console.warn('Failed to update map bounds', error);
                        }
                    });
            } else if (config?.center) {
                [window.choroplethMapInstance, window.expandedMapInstance]
                    .filter(Boolean)
                    .forEach(map => {
                        try {
                            map.setCenter(config.center);
                            if (config.zoom) map.setZoom(config.zoom);
                        } catch (error) {
                            console.warn('Failed to update map center', error);
                        }
                    });
            }
        };

        document.addEventListener('alpine:init', () => {
            Alpine.store('mapModal', {
                open: false
            })

            Alpine.data('choroplethMap', () => ({
                map: null,
                expandedMap: null,
                modalOpen: false,
                title: 'County Turnout Overview',
                subtitle: 'November 2024 | Top 10 Counties',
                datasetKey: 'Counties',
                legend: null,
                mapReady: false,
                pendingDatasetKey: null,
                init() {
                    if (!window.mapboxgl || !mapboxgl.accessToken) {
                        console.warn('Mapbox token missing or MapboxGL not loaded');
                        return;
                    }
                    this.initializeMap('map');
                    window.updateChoroplethView = (key) => this.switchDataset(key);
                    this.switchDataset(this.datasetKey);
                },
                initializeMap(containerId, isExpanded = false) {
                    const mapInstance = new mapboxgl.Map({
                        container: containerId,
                        style: 'mapbox://styles/mapbox/light-v11',
                        center: [-98.5795, 39.8283],
                        zoom: 4,
                        pitch: 0,
                        bearing: 0,
                        antialias: true
                    });

                    const usBounds = [[-130.0, 20.0], [-60.0, 55.0]];
                    mapInstance.setMaxBounds(usBounds);
                    mapInstance.dragRotate.disable();
                    mapInstance.touchZoomRotate.disableRotation();
                    mapInstance.setProjection('mercator');

                    mapInstance.on('load', () => {
                        this.mapReady = true;
                        const targetKey = this.pendingDatasetKey || window.currentDatasetKey || this.datasetKey;
                        this.loadDataset(mapInstance, targetKey);
                        mapInstance.addControl(new mapboxgl.NavigationControl(), 'top-right');
                    });

                    mapInstance.on('error', (e) => {
                        console.error('Map error:', e);
                    });

                    if (isExpanded) {
                        this.expandedMap = mapInstance;
                        window.expandedMapInstance = mapInstance;
                    } else {
                        this.map = mapInstance;
                        window.choroplethMapInstance = mapInstance;
                    }
                },
                loadDataset(mapInstance, key) {
                    if (!mapInstance || typeof mapInstance.isStyleLoaded !== 'function') return;
                    if (!mapInstance.isStyleLoaded()) {
                        this.pendingDatasetKey = key;
                        mapInstance.once('styledata', () => {
                            if (this.pendingDatasetKey === key) {
                                this.pendingDatasetKey = null;
                                this.loadDataset(mapInstance, key);
                            }
                        });
                        return;
                    }

                    const dataSources = window.choroplethDatasets || {};
                    const dataset = dataSources[key] || dataSources['Counties'];
                    if (!dataset) return;

                    window.currentDatasetKey = key;
                    this.title = dataset.title;
                    this.subtitle = dataset.subtitle;
                    this.legend = dataset.legend;

                    const sourceId = 'voter-data';
                    const layerId = 'voter-choropleth';
                    const hoverLayerId = 'voter-choropleth-hover';

                    if (mapInstance.getLayer(hoverLayerId)) mapInstance.removeLayer(hoverLayerId);
                    if (mapInstance.getLayer(layerId)) mapInstance.removeLayer(layerId);
                    if (mapInstance.getSource(sourceId)) mapInstance.removeSource(sourceId);

                    const filters = {
                        state: window.dashboardFilters?.state || window.currentStateKey,
                        election: window.dashboardFilters?.election || 'Nov 2024',
                        jurisdiction: key,
                        countries: window.dashboardFilters?.countries || []
                    };

                    const filteredData = window.getFilteredDatasetData(filters.state, key, filters) || dataset.data;

                    mapInstance.addSource(sourceId, {
                        type: 'geojson',
                        data: filteredData
                    });

                    mapInstance.addLayer({
                        id: layerId,
                        type: 'fill',
                        source: sourceId,
                        paint: dataset.paint
                    });

                    mapInstance.addLayer({
                        id: hoverLayerId,
                        type: 'line',
                        source: sourceId,
                        paint: {
                            'line-color': '#ffffff',
                            'line-width': 1.5
                        },
                        filter: ['==', ['get', 'name'], '']
                    });

                    const popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });

                    mapInstance.on('mousemove', layerId, (e) => {
                        if (!e.features?.length) return;
                        const feature = e.features[0];
                        mapInstance.setFilter(hoverLayerId, ['==', ['get', dataset.tooltipKey], feature.properties[dataset.tooltipKey]]);
                        popup.setLngLat(e.lngLat)
                            .setHTML(dataset.tooltipTemplate(feature.properties))
                            .addTo(mapInstance);
                    });

                    mapInstance.on('mouseleave', layerId, () => {
                        mapInstance.setFilter(hoverLayerId, ['==', ['get', dataset.tooltipKey], '']);
                        popup.remove();
                    });

                    if (dataset.fitBounds) {
                        mapInstance.fitBounds(dataset.fitBounds, { padding: 30, maxZoom: dataset.maxZoom ?? 8 });
                    }
                },
                openModal() {
                    this.modalOpen = true;
                    this.$nextTick(() => {
                        const targetKey = window.currentDatasetKey || this.datasetKey;
                        if (this.expandedMap) {
                            try {
                                this.expandedMap.remove();
                            } catch (error) {
                                console.warn('Failed to remove expanded map', error);
                            }
                            this.expandedMap = null;
                            window.expandedMapInstance = null;
                        }
                        requestAnimationFrame(() => this.initializeExpandedMap(targetKey));
                    });
                },
                closeModal() {
                    this.modalOpen = false;
                    if (this.expandedMap) {
                        try {
                            this.expandedMap.remove();
                        } catch (error) {
                            console.warn('Failed to remove expanded map on close', error);
                        }
                        this.expandedMap = null;
                        window.expandedMapInstance = null;
                    }
                },
                initializeExpandedMap(initialKey) {
                    const stateConfig = window.stateConfigs[window.currentStateKey];
                    const mapInstance = new mapboxgl.Map({
                        container: 'expanded-map',
                        style: 'mapbox://styles/mapbox/light-v11',
                        center: stateConfig?.center || [-98.5795, 39.8283],
                        zoom: stateConfig?.zoom || 4,
                        pitch: 0,
                        bearing: 0,
                        antialias: true
                    });

                    const usBounds = [[-130.0, 20.0], [-60.0, 55.0]];
                    mapInstance.setMaxBounds(usBounds);
                    mapInstance.dragRotate.disable();
                    mapInstance.touchZoomRotate.disableRotation();
                    mapInstance.setProjection('mercator');

                    mapInstance.on('load', () => {
                        mapInstance.addControl(new mapboxgl.NavigationControl(), 'top-right');
                        this.loadDataset(mapInstance, initialKey || window.currentDatasetKey || this.datasetKey);
                        requestAnimationFrame(() => {
                            try {
                                mapInstance.resize();
                            } catch (error) {
                                console.warn('Failed to resize expanded map after load', error);
                            }
                        });
                    });

                    mapInstance.on('error', (e) => {
                        console.error('Expanded map error:', e);
                    });

                    this.expandedMap = mapInstance;
                    window.expandedMapInstance = mapInstance;
                },
                switchDataset(key) {
                    window.currentDatasetKey = key;
                    this.datasetKey = key;
                    if (this.map) {
                        this.loadDataset(this.map, key);
                    }
                    if (this.expandedMap) {
                        this.loadDataset(this.expandedMap, key);
                        requestAnimationFrame(() => {
                            try {
                                this.expandedMap.resize();
                            } catch (error) {
                                console.warn('Failed to resize expanded map after dataset switch', error);
                            }
                        });
                    }
                }
            }));

            Alpine.data('stateSelector', () => ({
                open: false,
                selectedKey: window.dashboardFilters?.state || window.currentStateKey,
                get selectedLabel() {
                    return window.stateConfigs[this.selectedKey]?.label || 'Select state';
                },
                states: Object.entries(window.stateConfigs).map(([key, config]) => ({
                    key,
                    label: config.label,
                    abbr: config.abbr
                })),
                init() {
                    window.addEventListener('dashboard:update', (event) => {
                        if (event.detail?.filters?.state) {
                            this.selectedKey = event.detail.filters.state;
                        }
                    });
                },
                toggle() {
                    this.open = !this.open;
                },
                close() {
                    this.open = false;
                },
                selectState(stateKey) {
                    if (this.selectedKey === stateKey) {
                        this.close();
                        return;
                    }

                    this.selectedKey = stateKey;
                    window.applyDashboardFilters?.({ state: stateKey });
                    this.close();
                }
            }));
        })

        function turnoutGaugeWidget(initialTurnout = 53, totalEligible = 61821, totalVoted = 32795) {
            const radius = 80;
            const circumference = Math.PI * radius;

            return {
                turnout: Number(initialTurnout) || 0,
                totalEligible,
                totalVoted,
                expanded: false,
                get gaugeStroke() {
                    return circumference;
                },
                get gaugeOffset() {
                    const ratio = Math.max(0, Math.min(this.turnout, 100)) / 100;
                    return circumference * (1 - ratio);
                },
                get needlePosition() {
                    const clamped = Math.max(0, Math.min(this.turnout, 100));
                    const angle = Math.PI - (Math.PI * (clamped / 100));
                    return {
                        x: 100 + radius * Math.cos(angle),
                        y: 100 - radius * Math.sin(angle)
                    };
                },
                toggleFullscreen() {
                    this.expanded = !this.expanded;
                },
                get trendLabel() {
                    return this.turnout + '% â€¢ steady';
                },
                formatNumber(value) {
                    return new Intl.NumberFormat().format(value);
                }
            };
        }

        // Wait for Chart.js to load
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize charts first
            initializeCharts();
        });

        function initializeCharts() {
            // Initialize turnout chart configuration
            const turnoutChartConfig = {
                type: 'line',
                data: {
                    labels: ['Nov 23', 'Feb 24', 'Aug 24', 'Nov 24', 'Aug 25'],
                    datasets: [{
                        data: [49, 52, 55, 51, 53],
                        borderColor: '#2563eb',
                        borderWidth: 2.5,
                        pointRadius: 0,
                        tension: 0.4,
                        fill: {
                            target: 'origin',
                            above: 'rgba(37, 99, 235, 0.12)'
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { display: false },
                        y: { display: false, suggestedMin: 45, suggestedMax: 60 }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            };

            // Initialize desktop turnout chart
            const turnoutCtx = document.getElementById('turnoutTrendSparkline');
            if (turnoutCtx) {
                new Chart(turnoutCtx, turnoutChartConfig);
            }

            // Initialize mobile turnout chart
            const turnoutCtxMobile = document.getElementById('turnoutTrendSparklineMobile');
            if (turnoutCtxMobile) {
                new Chart(turnoutCtxMobile, JSON.parse(JSON.stringify(turnoutChartConfig)));
            }

            // Initialize ethnicity chart
            const ethnicityCtx = document.getElementById('ethnicityChart');
            if (ethnicityCtx) {
                new Chart(ethnicityCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['South Asian', 'Middle Eastern', 'African', 'Southeast Asian'],
                        datasets: [{
                            data: [45, 30, 15, 10],
                            backgroundColor: [
                                '#4361EE',  // South Asian (blue)
                                '#3A0CA3',  // Middle Eastern (deep purple)
                                '#7209B7',  // African (medium purple)
                                '#B5179E'   // Southeast Asian (light purple)
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                align: 'center',
                                labels: {
                                    color: '#4b5563',
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    font: {
                                        family: "'Inter', sans-serif",
                                        size: 12
                                    },
                                    boxWidth: 8
                                }
                            },
                            tooltip: {
                                backgroundColor: '#1f2937',
                                titleFont: {
                                    family: "'Inter', sans-serif",
                                    size: 14,
                                    weight: '600'
                                },
                                bodyFont: {
                                    family: "'Inter', sans-serif",
                                    size: 13
                                },
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + '%';
                                    }
                                }
                            }
                        },
                        cutout: '70%'
                    }
                });
            }
        }

        // Simulate loading state
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('loading-overlay').style.opacity = '0';
                document.getElementById('dashboard-content').style.opacity = '1';
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                }, 300);
            }, 1000);
        });

        // Initialize Lucide icons
        lucide.createIcons();

        // Set Mapbox access token (used by Alpine component)
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2FqYS1yIiwiYSI6ImNtZXRjaHhiajAwcjgya3B5cjJqaDljZGwifQ.o1uEOA7pV2RB_0A8jicwqg';

        // Initialize Charts
        // Date range picker modal
        const dateRangeModal = document.createElement('div');
        dateRangeModal.innerHTML = `
            <div id="dateRangePicker" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 w-96">
                    <h3 class="text-lg font-semibold mb-4">Select Date Range</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="endDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div class="flex justify-end gap-3">
                            <button onclick="closeDateRangePicker()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md">Cancel</button>
                            <button onclick="applyDateRange()" class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary-dark rounded-md">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(dateRangeModal);

        const electionChartCanvas = document.getElementById('turnoutByElectionChart');
        if (electionChartCanvas) {
            const turnoutBarCtx = electionChartCanvas.getContext('2d');
            window.turnoutBarChart = new Chart(turnoutBarCtx, {
            type: 'bar',
            data: {
                labels: ['Aug 23', 'Nov 23','Feb 24', 'Aug 24', 'Nov 24', 'Aug 25'],
                datasets: [{
                    data: [58, 65, 72, 68, 76, null],
                    backgroundColor: '#2563eb',
                    borderRadius: {
                        topLeft: 4,
                        topRight: 4
                    },
                    barThickness: 40,
                    hoverBackgroundColor: '#1d4ed8'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 20,
                        right: 20,
                        bottom: 20,
                        left: 20
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: '#f3f4f6',
                            drawBorder: false
                        },
                        border: {
                            display: false
                        },
                        ticks: {
                            color: '#4b5563',
                            font: {
                                family: "'Inter', sans-serif",
                                size: 12
                            },
                            padding: 8,
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        border: {
                            display: false
                        },
                        ticks: {
                            color: '#4b5563',
                            font: {
                                family: "'Inter', sans-serif",
                                size: 12
                            },
                            padding: 8
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        titleFont: {
                            family: "'Inter', sans-serif",
                            size: 14,
                            weight: '600'
                        },
                        bodyFont: {
                            family: "'Inter', sans-serif",
                            size: 13
                        },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + '% Turnout';
                            }
                        }
                    }
                }
            }
        });
        }

        const futuristicCtx = document.getElementById('turnoutBarChart');
        if (futuristicCtx) {
            const baseGradient = futuristicCtx.getContext('2d').createLinearGradient(0, 0, 0, 320);
            baseGradient.addColorStop(0, 'rgba(59, 130, 246, 0.95)');
            baseGradient.addColorStop(1, 'rgba(14, 165, 233, 0.45)');

            window.futuristicCountryChart = new Chart(futuristicCtx, {
                type: 'bar',
            data: {
                    labels: [],
                datasets: [{
                        label: 'Turnout %',
                        data: [],
                        backgroundColor: baseGradient,
                        borderRadius: 12,
                        barPercentage: 0.6,
                        categoryPercentage: 0.6,
                        hoverBackgroundColor: '#2563eb',
                        totalValues: []
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                            color: '#4b5563',
                                font: { family: "'Inter', sans-serif", size: 11 }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 110,
                            grid: {
                                color: 'rgba(148, 163, 184, 0.2)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#4b5563',
                                font: { family: "'Inter', sans-serif", size: 11 },
                                callback: value => value + '%'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#0f172a',
                            titleFont: { family: "'Inter', sans-serif", size: 13, weight: '600' },
                            bodyFont: { family: "'Inter', sans-serif", size: 12 },
                        padding: 12,
                            cornerRadius: 10,
                        callbacks: {
                                label: context => {
                                    const dataset = context.dataset;
                                    const totalValues = dataset.totalValues || [];
                                    const total = totalValues[context.dataIndex];
                                    return [
                                        `Turnout: ${context.parsed.y}%`,
                                        total != null ? `Total Voters: ${Number(total).toLocaleString()}` : null
                                    ].filter(Boolean);
                                }
                            }
                        }
                    }
                }
            });
        }


        // Filter functions
        function filterLastElection() {
            // Update chart data for the most recent election (November 2024)
            turnoutChart.data.labels = ['Nov 24'];
            turnoutChart.data.datasets[0].data = [76];
            turnoutChart.update();
            
            // Update KPI cards
            document.querySelector('.stat-value').textContent = '76%';
            document.querySelector('.text-success').innerHTML = `
                <i data-lucide="trending-up" class="w-4 h-4"></i>
                <span>4.2%</span>
            `;

            // Update jurisdiction data
            const topJurisdictions = document.querySelector('.top-jurisdictions');
            if (topJurisdictions) {
                // Update with November 2024 data
                topJurisdictions.innerHTML = `
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="font-medium">King County</span>
                            <span class="stat-value">89,450</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: 100%"></div>
                        </div>
                    </div>
                `;
            }

            // Update active button state
            document.querySelectorAll('header button').forEach(btn => {
                btn.classList.remove('text-primary');
                if (btn.textContent.includes('Last Election')) {
                    btn.classList.add('text-primary');
                }
            });

            lucide.createIcons();
        }

        function showDateRangePicker() {
            document.getElementById('dateRangePicker').classList.remove('hidden');
        }

        function closeDateRangePicker() {
            document.getElementById('dateRangePicker').classList.add('hidden');
        }

        function applyDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            // Format dates for display
            const formattedStartDate = new Date(startDate).toLocaleDateString();
            const formattedEndDate = new Date(endDate).toLocaleDateString();
            
            // Update the displayed date range
            const dateRangeElement = document.querySelector('[x-data*="dateRange"]');
            if (dateRangeElement) {
                const alpineData = Alpine.raw(dateRangeElement.__x.$data);
                alpineData.dateRange = `${formattedStartDate} - ${formattedEndDate}`;
                alpineData.open = false;
            }

            // Update chart with filtered data
            const filteredData = filterDataByDateRange(startDate, endDate);
            turnoutChart.data.labels = filteredData.labels;
            turnoutChart.data.datasets[0].data = filteredData.data;
            turnoutChart.update();
        }

        function filterDataByDateRange(startDate, endDate) {
            // This is a placeholder function - in reality, you would fetch data from your backend
            const allData = {
                labels: ['Nov 24', 'Aug 24', 'Feb 24', 'Nov 23', 'Aug 23'],
                data: [76, 68, 58, 72, 65]
            };
            
            // Filter data based on date range
            // This is simplified - you should use proper date comparison
            return allData;
        }

        // Cache common filter combinations
        const cachedFilters = {
            'last-election': {
                period: 'November 2024',
                jurisdiction: 'County',
                ethnicity: 'All'
            }
        };

        // Handle filter changes
        document.querySelectorAll('input[type="checkbox"], button').forEach(element => {
            element.addEventListener('click', () => {
                // Simulate loading state for filter changes
                const overlay = document.createElement('div');
                overlay.className = 'absolute inset-0 bg-surface-0 bg-opacity-50 flex items-center justify-center';
                overlay.innerHTML = '<div class="spinner"></div>';
                
                setTimeout(() => {
                    overlay.remove();
                }, 500);
            });
        });
    </script>
</body>
</html>
